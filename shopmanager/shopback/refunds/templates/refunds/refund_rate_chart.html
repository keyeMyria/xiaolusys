<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>商品退货统计</title>
    <link href="{{ STATIC_URL }}bootstrap/css/bootstrap3.2.0.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ STATIC_URL }}jquery/jquery-ui-1.10.1.css"/>
    <script src="{{ STATIC_URL }}jquery/jquery-1.8.13.min.js"></script>
    <script src='{{ STATIC_URL }}jquery/addons/jquery.form.js'></script>
    <script src="{{ STATIC_URL }}bootstrap/js/bootstrap-3.2.0.min.js"></script>
    <link href="{{ STATIC_URL }}jquery-timepicker-addon/timepicker/jquery-ui-timepicker-addon.css" type="text/css"/>
    <script src="{{ STATIC_URL }}jquery/jquery-ui-1.8.13.min.js"></script>
    <script src="{{ STATIC_URL }}jquery-timepicker-addon/timepicker/jquery-ui-timepicker-addon.js"
            type="text/javascript"></script>
    <script src="{{ STATIC_URL }}jquery-timepicker-addon/js/jquery-ui-timepicker-zh-CN.js"
            type="text/javascript"></script>
    <script src="{{ STATIC_URL }}fixed-header-table-master/jquery.fixedheadertable.min.js"
            type="text/javascript"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}jquery-json/jquery.json.js"></script>
    <script src="{{ STATIC_URL }}jquery-datatable-addon/jquery.dataTables.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}layer-v1.9.2/layer/layer.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}layer-v1.9.2/layer/extend/layer.ext.js"></script>
    <style type="text/css" title="currentStyle">
        @import "{{ STATIC_URL }}jquery-datatable-addon/css/demo_page.css";
        @import "{{ STATIC_URL }}jquery-datatable-addon/css/demo_table.css";
        @import "{{ STATIC_URL }}fixed-header-table-master/css/defaultTheme.css";
    </style>
    <script src="{{ STATIC_URL }}Chart-js/Chart.min.js"></script>
</head>

<body class="container">
<div>
    <h3>退款率图表</h3>
</div>
<div>
    <div class="input-group ">
        <span class="input-group-addon" id="date_from">开始时间</span>
        <input type="text" name="date_from" id="left_date_pic"
               class="form-control select_saletime  datepicker" placeholder="" value="{{ time_from }}"
               aria-describedby="basic-addon1">
        <span class="input-group-addon" id="date_to">结束时间</span>
        <input type="text" name="date_to" id="right_date_pic"
               class="form-control select_saletime  datepicker" placeholder="" value="{{ time_to }}"
               aria-describedby="basic-addon2">
            <span class="input-group-btn">
                <button class="btn btn-success" id="go_search" type="submit">Go!</button>
            </span>
    </div>
</div>

<div class="col-lg-12" id="div_myChart" style="margin-top: 30px">
    <canvas id="myChart" width="1100" height="200"></canvas>
</div>
<div class="col-lg-12" id="div_myChart_rate">
    <canvas id="myChart_rate" width="1100" height="400"></canvas>
</div>

<div style="margin-top: 30px;margin-bottom: 40px">
    <h4>数量记录</h4>
    <span class="label label-default">付款数</span>
    <span class="label label-success">24小时内退款数</span>
    <span class="label label-warning">24小时外退款数</span>
    <span class="label label-danger">退货数</span>
</div>

<div class="col-lg-12" id="div_refund_rcord">
    <canvas id="refund_rcord" width="1100" height="200"></canvas>
</div>

<div class="col-lg-12" id="div_refund_rcord_rate" style="margin-top: 30px">
    <canvas id="refund_rcord_rate" width="1100" height="200"></canvas>
</div>


<div style="margin-top: 100px">
    <h4>退款率线性回归</h4>
</div>
<div class="col-lg-12" id="div_lin_ana" style="margin-top: 10px">
    <canvas id="lin_ana" width="1100" height="400"></canvas>
</div>

</body>

<script type="text/javascript">
    $(function () {
        $(".select_saletime").datepicker({
            dateFormat: "yy-mm-dd"
        });
    });
    function chartShow(X_axis, Y_axis1, Y_axis2, Y_axis3, LineArray) {
        var ctx = $("#myChart").get(0).getContext("2d");
        var ctx_rate = $("#myChart_rate").get(0).getContext('2d');
        var line = $("#lin_ana").get(0).getContext("2d");
        var data = {
            labels: X_axis,//日期数组
            datasets: [
                {
                    fillColor: "rgba(220,220,220,0.5)",
                    strokeColor: "rgba(220,220,220,1)",
                    pointColor: "rgba(80%,10%,10%,1)",
                    pointStrokeColor: "#fff",
                    data: Y_axis1//退款数数组
                },
                {
                    fillColor: "rgba(151,187,205,0.5)",
                    strokeColor: "rgba(151,187,205,1)",
                    pointColor: "rgba(151,187,205,1)",
                    pointStrokeColor: "#fff",
                    data: Y_axis2//付款数数组
                }
            ]
        };
        var rate_data = {
            labels: X_axis,//日期数组
            datasets: [
                {
                    fillColor: "rgba(151,187,205,0.5)",
                    strokeColor: "rgba(80%,10%,10%,1)",
                    pointColor: "rgba(255,255,100,1)",
                    pointStrokeColor: "#fff",
                    data: Y_axis3//退款率数组
                }
            ]
        };

        var line_data = {
            labels: X_axis,//日期数组
            datasets: [
                {
                    fillColor: "rgba(151,187,205,0.5)",
                    strokeColor: "rgba(80%,10%,10%,1)",
                    pointColor: "rgba(255,255,100,1)",
                    pointStrokeColor: "#fff",
                    data: LineArray//线性回归
                }
            ]
        };
        new Chart(ctx).Line(data);
        new Chart(ctx_rate).Line(rate_data);
        new Chart(line).Line(line_data);
    }

    $(document).ready(function () {
        // 默认加载　渲染的时间
        var date_from = $("#left_date_pic").val();
        var date_to = $("#right_date_pic").val();
        getRateData(date_from, date_to);
        getRcordData(date_from, date_to);
        $("#go_search").click(function () {
            var date_from = $("#left_date_pic").val();
            var date_to = $("#right_date_pic").val();

            if (date_from == '' || date_to == '') {
                layer.msg('时间不能为空');
                return
            }
            else {
                $("#refund_rcord").remove();
                $("#refund_rcord_rate").remove();
                $("#myChart").remove();
                $("#myChart_rate").remove();
                $("#lin_ana").remove();

                var div_myChart = '<canvas id="myChart" width="1100" height="200"></canvas>';
                var myChart_rate = '<canvas id="myChart_rate" width="1100" height="400"></canvas>';
                var refund_rcord = '<canvas id="refund_rcord" width="1100" height="200"></canvas>';
                var refund_rcord_rate = '<canvas id="refund_rcord_rate" width="1100" height="200"></canvas>';
                var lin_ana = '<canvas id="lin_ana" width="1100" height="400"></canvas>';
                $("#div_refund_rcord").append(refund_rcord);
                $("#div_refund_rcord_rate").append(refund_rcord_rate);
                $("#div_myChart").append(div_myChart);
                $("#div_myChart_rate").append(myChart_rate);
                $("#div_lin_ana").append(lin_ana);

                getRateData(date_from, date_to);
                getRcordData(date_from, date_to);
            }
        });
    });

    <!-- 获取退款率数据 -->
    function getRateData(t1, t2) {
        var task_url = '/refunds/ref_rate/';
        var data = {"date_from": t1, "date_to": t2};
        $.ajax({
            url: task_url,
            data: data,
            type: "post",
            dataType: "json",
            success: taskCallBack
        });
        function taskCallBack(res) {
            var X_axis = []; // X_axis : 日期
            var Y_axis1 = []; //退款数数组
            var Y_axis2 = []; //付款数数组
            var Y_axis3 = []; //退款率数组  回归方程的纵轴

            $.each(res, function (i, rate) {
                X_axis.push(rate.date_cal);
                Y_axis1.push(rate.ref_num);
                Y_axis2.push(rate.pay_num);
                Y_axis3.push(rate.ref_rate);
            });
            console.log('数组长度:', Y_axis3.length);
            // 回归分析
            var X_array = new Array();
            for (var i = 0; i < X_axis.length; i++) {
                X_array.push(i);
            }
            var LineArray = LineXy(X_array, Y_axis3);
            console.log("LineArray:", LineArray);
            chartShow(X_axis, Y_axis1, Y_axis2, Y_axis3, LineArray);// 调用图标处理
        }
    }

    <!-- 获取退款记录表中数据 -->
    function getRcordData(t1, t2) {
        var task_url = '/refunds/ref_rcord/';
        var data = {"date_from": t1, "date_to": t2};
        $.ajax({
            url: task_url,
            data: data,
            type: "post",
            dataType: "json",
            success: taskCallBack
        });
        function taskCallBack(res) {
            var X_axis = []; // X_axis : 日期
            var Y_axis1 = []; //24h外未发货申请数
            var Y_axis2 = []; //24h内未发货申请数
            var Y_axis3 = []; //发货后申请数
            var Y_axis4 = []; //付款数数组 总数

            var Y_axis5 = [];
            var Y_axis6 = [];
            var Y_axis7 = [];

            $.each(res, function (i, record) {
                X_axis.push(record.date_cal);
                Y_axis1.push(record.ref_num_out);
                Y_axis2.push(record.ref_num_in);
                Y_axis3.push(record.ref_sed_num);
                Y_axis4.push(record.pay_num);

                Y_axis5.push(parseFloat((record.ref_num_out / record.pay_num).toFixed(4)));// 24外率
                Y_axis6.push(parseFloat((record.ref_num_in / record.pay_num).toFixed(4)));// 24内率
                Y_axis7.push(parseFloat((record.ref_sed_num / record.pay_num).toFixed(4)));// 发货后率

            });
            // 回归分析
            chartRecordShow(X_axis, Y_axis1, Y_axis2, Y_axis3, Y_axis4, Y_axis5, Y_axis6, Y_axis7);// 调用图标处理
        }
    }

    function chartRecordShow(X_axis, Y_axis1, Y_axis2, Y_axis3, Y_axis4, Y_axis5, Y_axis6, Y_axis7) {
        var ctx = $("#refund_rcord").get(0).getContext("2d");
        var ctx_rate = $("#refund_rcord_rate").get(0).getContext('2d');
        var data = {
            labels: X_axis,//日期数组
            datasets: [
                {
                    fillColor: "rgba(220,220,220,0.5)",
                    strokeColor: "yellow",
                    pointColor: "yellow",
                    pointStrokeColor: "yellow",
                    data: Y_axis1//24h外未发货申请数
                },
                {
                    fillColor: "rgba(151,187,205,0.5)",
                    strokeColor: "green",
                    pointColor: "green",
                    pointStrokeColor: "green",
                    data: Y_axis2//24h内未发货申请数
                },
                {
                    fillColor: "rgba(220,220,220,0.5)",
                    strokeColor: "red",
                    pointColor: "red",
                    pointStrokeColor: "red",
                    data: Y_axis3//发货后申请数
                },
                {
                    fillColor: "rgba(151,187,205,0.5)",
                    strokeColor: "black",
                    pointColor: "black",
                    pointStrokeColor: "black",
                    data: Y_axis4//付款数数组 总数
                }
            ]
        };
        var rate_data = {
            labels: X_axis,//日期数组
            datasets: [
                {
                    fillColor: "rgba(220,220,220,0.5)",
                    strokeColor: "yellow",
                    pointColor: "yellow",
                    pointStrokeColor: "yellow",
                    data: Y_axis5//24h外未发货申请数
                },
                {
                    fillColor: "rgba(151,187,205,0.5)",
                    strokeColor: "green",
                    pointColor: "green",
                    pointStrokeColor: "green",
                    data: Y_axis6//24h内未发货申请数
                },
                {
                    fillColor: "rgba(220,220,220,0.5)",
                    strokeColor: "red",
                    pointColor: "red",
                    pointStrokeColor: "red",
                    data: Y_axis7//发货后申请数
                }
            ]
        };
        new Chart(ctx).Line(data);
        new Chart(ctx_rate).Line(rate_data);
        new Chart(pie).Pie(pie_data);
    }


    <!--字符串format函数-->
    String.format = function () {
        if (arguments.length == 0)
            return null;
        var str = arguments[0];
        for (var i = 1; i < arguments.length; i++) {
            var re = new RegExp('\\{' + (i - 1) + '\\}', 'gm');
            str = str.replace(re, arguments[i]);
        }
        return str;
    };


    <!--回归方程-->
    function LineXy(Xarry, Yarry) {
        // 回归方程 y = b_bar * x + a_bar
        var n = Xarry.length;
        var avg_x = Avg(Sum(Xarry), n, 4);//数组平均数
        var avg_y = Avg(Sum(Yarry), n, 4);//数组平均数
        var sgm_xiyi = Sum(Milti(Xarry, Yarry, 4));//数组 SIGEMA xiyi
        var sgm_xi2 = Sum(Milti(Xarry, Xarry, 4));

        var b_bar = (sgm_xiyi - n * avg_x * avg_y) / (sgm_xi2 - n * avg_x * avg_x);
        var a_bar = avg_y - b_bar * avg_x;

        console.log(avg_x, '-', avg_y, '-', sgm_xiyi, '-', sgm_xi2, '-', b_bar, '-', a_bar);
        //undefined "-" undefined "-" 28 "-" 51039 "-" NaN "-" NaN

        var resultArry = new Array();
        for (var i = 0; i < n; i++) {
            var y = b_bar * Xarry[i] + a_bar;
            resultArry.push(y);
        }
        return resultArry;


        function Milti(arr1, arr2, precision) {//数组乘积求和
            var miltiArr = new Array();
            for (var i = 0; i < arr1.length; i++) {
                var milti = parseFloat((arr1[i] * arr2[i]).toFixed(precision));
                miltiArr.push(milti);
            }
            return miltiArr
        }

        function Sum(array) {//数组各项求和
            var sumArray = 0;
            for (var i = 0; i < array.length; i++) {
                sumArray += parseFloat(array[i]);
            }
            return sumArray
        }

        function Avg(sum_value, len, precision) {// 求 数组的平均数, precision 为返回数字的精度
            return parseFloat((sum_value / len).toFixed(precision))
        }
    }
</script>
</html>


