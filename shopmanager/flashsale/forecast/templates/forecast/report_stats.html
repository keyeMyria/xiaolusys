<!DOCTYPE html>
{% load custom_filter %}
<html lang="en">
<head>
    <title>dc.js - Filtering Example</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/dc/2.0.0-alpha.3/dc.css"/>
    <style>
    * {
        padding: 0 0;
        margin: 0 0;
    }
    .chart-area{
        float:left;
    }
    .chart{
        margin: 30px 5px;
        float:left;
    }
    </style>
</head>
<body>
<div class="container">
    <div class="page-header">
        <h1>供应链订货/到货数据统计报表
            <small></small>
        </h1>
    </div>
    <div class="row">
        <div id="chart-supplier-amount" class="chart-area chart" style="width:24%; height:800px">
            <div>供应商 / 采购金额(百元) </div>
            <div class="reset" style="visibility: hidden;">selected: <span class="filter"></span>
                <a href="javascript:supplierRowChart.filterAll();dc.redrawAll();">reset</a>
            </div>
        </div>
        <div style="width:50%;" class="chart-area">
            <div id="chart-dinghuo-peroid" class="chart"  style="width:48%; height:300px">
                <div>到货周期 = 到货时间 - 订货时间</div>
                <div class="reset" style="visibility: hidden;">selected: <span class="filter"></span>
                    <a href="javascript:arrivalPeroidHistChart.filterAll();dc.redrawAll();">reset</a>
                </div>
            </div>
            <div id="chart-arrival-peroid" class="chart"  style="width:48%; height:300px">
                <div>发货周期 = 发货时间 - 订货时间</div>
                <div class="reset" style="visibility: hidden;">selected: <span class="filter"></span>
                    <a href="javascript:deliveryPeroidHistChart.filterAll();dc.redrawAll();">reset</a>
                </div>
            </div>
            <div id="chart-logistic-peroid" class="chart"  style="width:48%; height:300px">
                <div>物流周期 = 到货时间 - 发货时间</div>
                <div class="reset" style="visibility: hidden;">selected: <span class="filter"></span>
                    <a href="javascript:logisticPeroidHistChart.filterAll();dc.redrawAll();">reset</a>
                </div>
            </div>
            <div id="chart-chain-quantity" class="chart"  style="width:48%; height:300px">
                <div>物流周期 = 到货时间 - 发货时间</div>
                <div class="reset" style="visibility: hidden;">selected: <span class="filter"></span>
                    <a href="javascript:deliveryPeroidHistChart.filterAll();dc.redrawAll();">reset</a>
                </div>
            </div>
        </div>
        <div style="width:25%;" class="chart-area">
            <div id="chart-ring-buyer" class="chart"  style="width:100%;height:200px">
                <div>买手</div>
                <div class="reset" style="visibility: hidden;">range: <span class="filter"></span>
                    <a href="javascript:buyerRingChart.filterAll();dc.redrawAll();">reset</a>
                </div>
            </div>
            <div id="chart-ring-purchaser" class="chart"  style="width:100%;height:200px">
                <div>采购</div>
                <div class="reset" style="visibility: hidden;">range: <span class="filter"></span>
                    <a href="javascript:purchaserRingChart.filterAll();dc.redrawAll();">reset</a>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="//cdn.bootcss.com/d3/3.5.17/d3.min.js"></script>
    <script type="text/javascript" src="//cdn.bootcss.com/crossfilter/1.3.12/crossfilter.min.js"></script>
    <script type="text/javascript" src="//cdn.bootcss.com/dc/2.0.0-beta.30/dc.min.js"></script>
    <script type="text/javascript">
var supplierRowChart   = dc.rowChart("#chart-supplier-amount"),
    arrivalPeroidHistChart  = dc.barChart("#chart-dinghuo-peroid"),
    deliveryPeroidHistChart  = dc.barChart("#chart-arrival-peroid"),
    logisticPeroidHistChart  = dc.barChart("#chart-logistic-peroid"),
    buyerRingChart   = dc.pieChart("#chart-ring-buyer"),
    purchaserRingChart   = dc.pieChart("#chart-ring-purchaser");
// use static or load via d3.csv("spendData.csv", function(error, spendData) {/* do stuff */});
var spendData = {{ results|jsonify }};
// normalize/parse data
// set crossfilter
var ndx = crossfilter(spendData),
    supplierDim  = ndx.dimension(function(d) {return d.supplier__supplier_name}),
    buyerDim = ndx.dimension(function(d) {return d.buyer_name;}),
    purchaserDim = ndx.dimension(function(d) {return d.purchaser;}),
    arrivalPeroidDim  = ndx.dimension(function(d) {return d.arrival_period;}),
    logisticPeroidDim  = ndx.dimension(function(d) {return d.logistic_period;}),
    deliveryPeroidDim  = ndx.dimension(function(d) {return d.delivery_period;}),
    supplierAmountGroup = supplierDim.group().reduceSum(function(d) {return +d.purchase_amount;}),
    buyerAmountGroup = buyerDim.group().reduceSum(function(d) {return +d.purchase_amount;}),
    purchaserAmountGroup = purchaserDim.group().reduceSum(function(d) {return +d.purchase_amount;}),
    arrivalPeroidGroup = arrivalPeroidDim.group().reduceCount(),
    deliveryPeroidGroup = deliveryPeroidDim.group().reduceCount()
    logisticPeroidGroup = logisticPeroidDim.group().reduceCount();

// var trendDimension = ndx.dimension(function(d) {return [d.Expt, d.purchase_period]; });
// var trendGroup = runDimension.group().reduceSum(function(d) { return +d.Speed; });

supplierRowChart
    .dimension(supplierDim)
    .group(supplierAmountGroup)
    .elasticX(true)
    .controlsUseVisibility(true);
supplierRowChart.xAxis().tickFormat(function(d) {return parseInt(d / 100)});

arrivalPeroidHistChart
    .dimension(arrivalPeroidDim)
    .group(arrivalPeroidGroup)
    .x(d3.scale.linear().domain([0,10]))
    .elasticY(true)
    .controlsUseVisibility(true);

// dhPeroidHistChart.xAxis().tickFormat(function(d) {return d}); // convert back to base unit
// dhPeroidHistChart.yAxis().ticks(2);

deliveryPeroidHistChart
    .dimension(deliveryPeroidDim)
    .group(deliveryPeroidGroup)
    .x(d3.scale.linear().domain([0,10]))
    .elasticY(true)
    .controlsUseVisibility(true);

logisticPeroidHistChart
    .dimension(logisticPeroidDim)
    .group(logisticPeroidGroup)
    .x(d3.scale.linear().domain([0,10]))
    .elasticY(true)
    .controlsUseVisibility(true);

buyerRingChart
    .dimension(buyerDim)
    .group(buyerAmountGroup)
    .innerRadius(50)
    .controlsUseVisibility(true);

purchaserRingChart
    .dimension(purchaserDim)
    .group(purchaserAmountGroup)
    .innerRadius(50)
    .controlsUseVisibility(true);

/*
var chainQuanlityRingChart  = dc.barChart("#chart-chain-quantity"),
    quanlityDimension  = ndx.dimension(function(d) {return "run-"+d.Run;}),
    quanlitySumGroup = quanlityDimension.group().reduceSum(function(d) {return d.Speed * d.Run;});

chainQuanlityRingChart
  .slicesCap(4)
  .innerRadius(100)
  .externalLabels(50)
  .externalRadiusPadding(50)
  .drawPaths(true)
  .dimension(quanlityDimension)
  .group(quanlitySumGroup)
  .legend(dc.legend());
*/

/* chart
    .width(768)
    .height(480)
    .chart(function(c) { return dc.lineChart(c).interpolate('basis'); })
    .x(d3.scale.linear().domain([0,20]))
    .brushOn(false)
    .yAxisLabel("Measured Speed km/s")
    .xAxisLabel("Run")
    .clipPadding(10)
    .elasticY(true)
    .dimension(runDimension)
    .group(runGroup)
    .mouseZoomable(true)
    .seriesAccessor(function(d) {return "Expt: " + d.key[0];})
    .keyAccessor(function(d) {return +d.key[1];})
    .valueAccessor(function(d) {return +d.value - 500;})
    .legend(dc.legend().x(350).y(350).itemHeight(13).gap(5).horizontal(1).legendWidth(140).itemWidth(70));
chart.yAxis().tickFormat(function(d) {return d3.format(',d')(d+299500);});*/

dc.renderAll();




    </script>

</div>
</body>
</html>