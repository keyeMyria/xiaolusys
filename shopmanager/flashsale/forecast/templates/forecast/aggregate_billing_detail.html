
<div class="row">
    <ul class="nav nav-tabs nav-justified">
      <li role="presentation" class="active"><a href="#panel-1" data-toggle='tab'>商品订货/到货数量/金额统计</a></li>
      <li role="presentation"><a href="#panel-2" data-toggle='tab'>订单收支账单列表</a></li>
    </ul>
</div>
<div class="tab-content row" >
    <div class="panel panel-default tab-pane active" id="panel-1" >
        <div class="panel-body">
            <table id="table-1" class="table table-striped" >
                <thead>
                    <tr>
                        <th class="col-xs-1">图片</th>
                        <th class="col-xs-1">商品编码</th>
                        <th class="col-xs-2">商品名称</th>
                        <th class="col-xs-1">采购</th>
                        <th class="col-xs-1">到货</th>
                        <th class="col-xs-1">未到</th>
                        <!-- 6 -->
                        <th class="col-xs-1">多订</th>
                        <th class="col-xs-1">次品</th>
                        <th class="col-xs-1">退货</th>
                        <th class="col-xs-1">支付款</th>
                        <th class="col-xs-1">应退款</th>
                    </tr>
                </thead>
                <tbody>
                {% for detail in aggregate_details %}
                <tr>
                    <td>
                        <div class="portfolio-box">
                        <img class="thumbnail" data-src="{{detail.product_img}}" style="margin-bottom:0px;"
                             src="{{detail.product_img}}?imageMogr2/thumbnail/40/format/jpg/quality/90/crop/40x40"/>
                        </div>
                    </td>
                    <td>{{detail.outer_id}}</td>
                    <td>{{detail.product_name}}:{{detail.sku_name}}</td>
                    <td>{{detail.buy_num}}</td>
                    <td>{{detail.arrival_num}}</td>
                    <td class="{% if detail.delta_num < 0 %}bg-danger{% endif %}">{{detail.delta_num}}</td>
                     <!-- 6 -->
                    <td class="{% if detail.excess_num > 0 %}bg-warning{% endif %}">{{detail.excess_num}}</td>
                    <td class="{% if detail.inferior_num > 0 %}bg-primary{% endif %}">{{detail.inferior_num}}</td>
                    <td>{{detail.return_num}}</td>
                    <td>{{detail.real_payment}}</td>
                    <td>{{detail.return_amount}}</td>
                </tr>
                {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3">汇总:</td>
                        <td><input id="input-3" data-type="int" size="4"/></td>
                        <td><input id="input-4" data-type="int" size="4"/></td>
                        <td><input id="input-5" data-type="int" size="4"/></td>
                        <td><input id="input-6" data-type="int" size="4"/></td>
                        <td><input id="input-7" data-type="int" size="4"/></td>
                        <td><input id="input-8" data-type="int" size="4"/></td>
                        <td><input id="input-9" data-type="float" size="7"/></td>
                        <td><input id="input-10" data-type="float" size="7"/></td>
                    </tr>
                    <tr>
                        <th class="col-xs-1">图片</th>
                        <th class="col-xs-1">商品编码</th>
                        <th class="col-xs-2">商品名称</th>
                        <th class="col-xs-1">采购</th>
                        <th class="col-xs-1">到货</th>
                        <th class="col-xs-1">未到</th>
                        <!-- 6 -->
                        <th class="col-xs-1">多订</th>
                        <th class="col-xs-1">次品</th>
                        <th class="col-xs-1">退货</th>
                        <th class="col-xs-1">支付款</th>
                        <th class="col-xs-1">应退款</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    <div class="panel panel-default tab-pane" id="panel-2">
        <div class="panel-body">
            <table class="table table-striped" style="width:100%">
                <thead>
                    <tr>
                        <th class="col-xs-2">账单编号</th>
                        <th class="col-xs-2">业务日期</th>
                        <th class="col-xs-1">申请人</th>
                        <th class="col-xs-1">收/支</th>
                        <th class="col-xs-2">付款方式</th>
                        <th class="col-xs-1">付款</th>
                        <th class="col-xs-1">回款</th>
                        <th class="col-xs-1">状态</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bill in bill_data.bills %}
                    <tr>
                        <td>{{bill.id}}
                            <div class="inline pull-right">
                            {% if bill.note %}
                            <a tabindex="0" role="button" style="color:#333;" data-toggle="popover"  title="收付款单备注" data-content="{{bill.note}}">
                                <i class="glyphicon glyphicon-list-alt"></i>
                            </a>
                            {% endif %}
                            </div>
                        </td>
                        <td>{{bill.created|slice:":10"}}</td>
                        <td>{{bill.creater}}</td>
                        <td>{{bill.type_name}}</td>
                        <td>{{bill.pay_method_name}}</td>
                        <td>{{bill.out_amount}}</td>
                        <td>{{bill.in_amount}}</td>
                        <td>{{bill.status_name}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5">汇总:</td>
                        <td><input size="7" value="{{bill_data.total_in_amount}}"/></td>
                        <td><input size="7" value="{{bill_data.total_out_amount}}"/></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
<script>
function　calcIndexCell(index){
    var bodyCellRows = $("#table-1 tbody > tr");
    var $calcInputDown = $('input[id=input-'+ index +']');
    var data_type = $calcInputDown.attr('data-type');
    var calc_val = 0;
    for(var i=0; i< bodyCellRows.length; i++){
        if (bodyCellRows[i].cells.length < index) continue;
        var rowCell = bodyCellRows[i].cells[index];
        if (data_type == 'int'){
            calc_val += parseInt(rowCell.innerText);
        }else{
            calc_val += parseFloat(rowCell.innerText);
        }
    };
    calc_val = data_type == 'int'?calc_val:calc_val.toFixed(2);
    $calcInputDown.val(calc_val);
}

var calcStatsData = function () {
    for(var i=3; i<11; i++){
        calcIndexCell(i);
    };
}

$('[data-toggle="popover"]').popover();
var $oTable = $('#panel-1 table').dataTable({
    "scrollY": 600,
    "responsive": true,
    "bAutoWidth": true,
    "scrollCollapse": true,
    "paging": false,
    "ordering": true,
    "order": [[7, "desc"],[6,"desc"],[5,"asc"],[4,"asc"]] //次品,多发,错发,缺货
});

$oTable.closest(".dataTables_wrapper").find(".dataTables_scrollHeadInner").css("width","100%");
$oTable.closest(".dataTables_wrapper").find(".dataTables_scrollFootInner").css("width","100%");
$oTable.closest(".dataTables_wrapper").find(".dataTable").css("width","100%");

$('#panel-2 table').dataTable({
    "paging":   false,
    "ordering": true,
    "info":     false,
});

calcStatsData();
$("#table-1_length select").on('change',function(e){
    calcStatsData();
});
//搜索时，重新计算
$("#table-1_filter input").on('keyup',function(e){
    calcStatsData();
});
//排序后重新计算
$("#table-1 .sorting").on('click',function(e){
    calcStatsData();
});
//分页时，重新计算
$("#table-1_wrapper a").on('click',function(e){
    calcStatsData();
});

$('.portfolio-box img', '#panel-1').popover({
    html: true,
    trigger: 'hover',
    container: 'body',
    content: function(){
     return '<img src="'+ $(this).attr('data-src')
        +'?imageMogr2/thumbnail/400/format/jpg/quality/90" width="100%">';
    }
});

</script>