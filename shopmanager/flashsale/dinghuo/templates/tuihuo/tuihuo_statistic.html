<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>商品退货统计</title>
    <link href="{{ STATIC_URL }}bootstrap/css/bootstrap3.2.0.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ STATIC_URL }}jquery/jquery-ui-1.10.1.css"/>
    <script src="{{ STATIC_URL }}jquery/jquery-1.8.13.min.js"></script>
    <script src='{{ STATIC_URL }}jquery/addons/jquery.form.js'></script>
    <script src="{{ STATIC_URL }}bootstrap/js/bootstrap-3.2.0.min.js"></script>


    <link href="{{ STATIC_URL }}jquery-timepicker-addon/timepicker/jquery-ui-timepicker-addon.css" type="text/css"/>
    <script src="{{ STATIC_URL }}jquery/jquery-ui-1.8.13.min.js"></script>
    <script src="{{ STATIC_URL }}jquery-timepicker-addon/timepicker/jquery-ui-timepicker-addon.js"
            type="text/javascript"></script>
    <script src="{{ STATIC_URL }}jquery-timepicker-addon/js/jquery-ui-timepicker-zh-CN.js"
            type="text/javascript"></script>
</head>

<body class="container">

<div>
    <h3>商品库存退货统计</h3>
</div>
<div>
    <form method="get" id="my_form">
        <div class="input-group ">
            <span class="input-group-addon" id="mm_search">产品编号</span>
            <input type="text" name="outer_id" id="outer_id"
                   class="form-control  mama_base_data_search" placeholder="产品编号" value="{{ outer_id }}"
                   aria-describedby="basic-addon3">

            <span class="input-group-addon" id="date_from">开始时间</span>
            <input type="text" name="date_from" id="left_date_pic"
                   class="form-control select_saletime  datepicker" placeholder=""
                   value=""
                   aria-describedby="basic-addon1">

            <span class="input-group-addon" id="date_to">结束时间</span>
            <input type="text" name="date_to" id="right_date_pic"
                   class="form-control select_saletime  datepicker" placeholder="" value=""
                   aria-describedby="basic-addon2">
            <span class="input-group-btn">
                <button class="btn btn-default" id="go_search" type="submit">Go!</button>
            </span>
        </div>
    </form>
</div>

<div style="margin-top: 30px">

    <table class="table table-bordered">
        <thead>
        <tr>
            <th>图片</th>
            <th>商品编码</th>
            <th>名称</th>
            <th>库存</th>
            <th>待发数</th>

            <th>库存同步</th>
            <th>归属仓库</th>
            <th>上架状态</th>
            <th>商品备注</th>
            <th>退款数量</th>
            <th>退货数量</th>
            <th>供应商</th>
        </tr>
        </thead>
        <tbody>
        {% for i in pro %}
            <tr>
                <td><img src="{{ i.pic_path }}" style="height: 200px;width: 120px;"></td>
                <td>{{ i.outer_id }}</td>
                <td>{{ i.name }}</td>
                <td>{{ i.collect_num }}</td>
                <td>{{ i.wait_post_num }}</td>

                <td>{{ i.sync_stock }}</td>
                <td>{{ i.ware_by }}</td>
                <td>{{ i.shelf_status }}</td>
                <td>{{ i.memo }}</td>
                <td>{{ i.return_num }}</td>
                <td>{{ i.refund_num }}</td>
                <td id="td_supplier">
                    <a onclick="connect_supplier({{ i.sale_supplier_pk }},{{ i.id }})">{{ i.sale_supplier_name }}</a><br>
                    <span class="label label-info">联系人：</span>{{ i.sale_supplier_contact }}
                    <span class="label label-info">手机：</span>{{ i.sale_supplier_mobile }}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
</body>

<script type="text/javascript" src="{{ STATIC_URL }}layer-v1.9.2/layer/layer.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}layer-v1.9.2/layer/extend/layer.ext.js"></script>
<script type="text/javascript">
    $(function () {
        $("#left_date_pic").datepicker({
            dateFormat: "yy-mm-dd"
        });
        $("#right_date_pic").datepicker({
            dateFormat: "yy-mm-dd"
        });
    });
    function connect_supplier(suppleier_id, pro_id) {
        var html = '<div>' +
                '<div class="input-group" style="margin-top: 20px">' +
                '<span class="input-group-btn">' +
                '<button class="btn btn-default" type="button">退货数量</button>' +
                '</span><input type="text" class="form-control" id="return_num">' +
                '<span class="input-group-btn">' +
                '<button class="btn btn-default" type="button">退货总金额</button>' +
                '</span><input type="text" class="form-control" id="sum_amount">' +
                '<span class="input-group-btn"><button class="btn btn-default" type="button">备注</button>' +
                '</span></div><textarea id="return_memo" class="form-control" rows="5" style="margin-top: 20px"></textarea>' +
                '<button type="button" class="btn btn-warning return_supplier"  style="margin-top: 20px">确定</button>' +
                '</div>';
        layer.tab({
            area: ['600px', '300px'],
            tab: [{
                title: '退货给供应商',
                content: html
            }]
        });
        $(".layui-layer-page").removeClass("layui-layer-tab");//这句只是删除样式没有其他作用
        console.log("supplier", suppleier_id, pro_id);
        $(".return_supplier").click(function () {

            if ($(".return_supplier").hasClass("loading")) {
                return
            }
            var return_num = $("#return_num").val();
            var sum_amount = $("#sum_amount").val();
            var return_memo = $("#return_memo").val();
            console.log("return_num", return_num, "sum_amount", sum_amount, "return_memo", return_memo);
            var reqUrl = "/sale/dinghuo/tuihuo/";
            $(".return_supplier").addClass("loading");
            $.ajax({
                url: reqUrl,
                data: {
                    "pro_id": pro_id,
                    "suppleier_id": suppleier_id,
                    "return_num": return_num,
                    "sum_amount": sum_amount,
                    "return_memo": return_memo
                },
                type: "post",
                dataType: "json",
                success: requestCallBack
            });
            function requestCallBack(res) {
                $(".return_supplier").removeClass("loading");
                console.log(res);
                if (res.res == true) {
                    layer.confirm('退货单创建成功！关闭小窗口？', {
                        btn: ['确定'] //按钮
                    }, function () {
                        var already = '<h3><span class="label label-danger">已经处理</span></h3>';
                        $("#td_supplier").append(already);
                        layer.closeAll();
                    });
                }
                else{
                    layer.msg('创建出问题，请尝试刷新页面，不要重复提交！！！');
                }
            }
        });
    }
</script>
</html>