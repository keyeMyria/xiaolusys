{% load custom_filter %}
<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <title>小鹿美美 - 入库后台</title>
        <link href="{{ STATIC_URL }}bootstrap/css/bootstrap3.2.0.min.css" rel="stylesheet">
        <link href="{{ STATIC_URL }}animate.css" rel="stylesheet">
        <link href="{{ STATIC_URL }}plugins/xiaolu-uploader/uploader.css" rel="stylesheet">
        <link href="{{ STATIC_URL }}wap/css/sweet-alert.css" rel="stylesheet">
        <link href="{{ STATIC_URL }}chosen_v1.5.1/chosen.min.css" rel="stylesheet">
        <link href="{{ STATIC_URL }}bootstrap-tagsinput/dist/bootstrap-tagsinput.css" rel="stylesheet">
        <style>
         body > div.container {
             width: 98%;
             margin-top: 10px;
         }

         .typeahead,
         .tt-query,
         .tt-hint {
             height: 40px;
             padding: 8px 12px;
             font-size: 24px;
             line-height: 30px;
             border: 2px solid #ccc;
             -webkit-border-radius: 8px;
             -moz-border-radius: 8px;
             border-radius: 8px;
             outline: none;
         }

         .typeahead:focus {
             border: 2px solid #0097cf;
         }

         .tt-query {
             -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
             -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
             box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
         }

         .tt-hint {
             color: #999
         }

         .tt-menu {
             margin: 12px 0;
             padding: 8px 0;
             background-color: #fff;
             border: 1px solid #ccc;
             border: 1px solid rgba(0, 0, 0, 0.2);
             -webkit-border-radius: 8px;
             -moz-border-radius: 8px;
             border-radius: 8px;
             -webkit-box-shadow: 0 5px 10px rgba(0,0,0,.2);
             -moz-box-shadow: 0 5px 10px rgba(0,0,0,.2);
             box-shadow: 0 5px 10px rgba(0,0,0,.2);
         }

         .tt-suggestion {
             padding: 3px 20px;
             font-size: 18px;
             line-height: 24px;
         }

         .tt-suggestion:hover {
             cursor: pointer;
             color: #fff;
             background-color: #0097cf;
         }

         .tt-suggestion.tt-cursor {
             color: #fff;
             background-color: #0097cf;
         }

         .tt-suggestion p {
             margin: 0;
         }

         .gist {
             font-size: 14px;
         }

         label.control-label {
             font-size: 20px;
         }

         #form-1 .btn {
             font-size: 20px;
         }

         .panel {
             margin: 20px auto;
             width: 98.5%;
         }

         .portfolio-box img {
             width: 100px;
             box-shadow: 2px 2px 5px rgba(187, 187, 187, 0.5);
             -webkit-transition: -webkit-transform 0.2s ease-out;
             -moz-transition: -moz-transform 0.2s ease-out;
             -o-transition: -o-transform 0.2s ease-out;
             transition: transform 0.2s ease-out;
         }

         .portfolio-box img:hover {
             -webkit-transform: scale(1) rotate(20deg);
             -moz-transform: scale(1) rotate(20deg);
             -o-transform: scale(1) rotate(20deg);
             -ms-transform: scale(1) rotate(20deg);
             transform: scale(1) rotate(20deg);
         }

         #form-2, #form-2 .btn {
             font-size: 20px;
         }

         #form-2 input[type="number"] {
             text-align: center;
         }
         #form-2 input{
             font-size: 18px;
             padding-bottom: 5px;
         }

        #tips {
            margin: 20px auto 0;
         }
         #tips .noty_message {
             font-size: 20px !important;
             line-height: 20px !important;
             height: 50px;
             padding: 20px 0 35px !important;
         }

         #memo-panel {
	     position: fixed;
	     bottom: 100px;
             width: 80px;
             top: 36%;
             left: 10px;
	     text-align: center;
	     z-index: 1;
         }
         #memo-panel a{
             font-size: 18px;
             width: 75px;
             display: inline-block;
         }
         #memo-panel span {
             font-size: 18px;
             width: 75px;
             display: inline-block;
             font-weight: 400;
             line-height: 1.42857143;
         }

         #cancel-btn {
             display: none;
         }
         .chosen-container span, .chosen-results li {
             font-size: 16px;
             font-weight: normal;
         }
         i.warning {
             color: red;
             display: none;
         }

         i.remove {
             position: absolute;
             left: -80px;
         }
         i.remove:hover {color: #ff4500;}

         tr.detail td:first-child input {width: 200px; display: inline-block}
         div.bootstrap-tagsinput {width: 120px; height: 36px;}
         #form2 div.tt-menu{width: 120px;}

         #memo-panel ul {list-style-type:none;}
         #memo-panel ul > li {line-height: 50px}
         #form-2 span.twitter-typeahead, #form-2 input.tt-input, #form-2 input.tt-hint {width: 120px;}
        </style>
    </head>
    <body>
        <div class="container">
            <form id="form-1">
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label class="control-label">快递单号</label>
                        <input class="form-control typeahead" id="express-no"
                               name="express_no" placeholder="输入..." value="{{ express_no|default:'' }}">
                    </div>
                    <div class="col-md-6 form-group">
                        <label class="control-label">供应商</label>
                        <input class="form-control typeahead" id="supplier"
                               name="supplier" placeholder="输入..." value="{{ supplier|default:'' }}">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <a class="btn btn-default btn-block reset" href="javascript:;">重置</a>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-primary btn-block submit">确定</button>
                    </div>
                </div>
                <input type="hidden" id="target-id" name="target_id" value="{{ target_id|default:0 }}">
                <input type="hidden" id="sent-from" name="sent_from" value="{{ sent_from|default:1 }}">
                <input type="hidden" id="inbound-id" name="inbound_id" value="{{ inbound_id|default:0 }}">
            </form>
            {% if products %}
            <form id="form-2">
                <div class="row" id="tips">
                </div>
                <div class="row">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <h2 style="text-align:center">
                                {% if sent_from == 1 %}
                                供应商入库
                                {% else %}
                                退货入仓
                                {% endif %}
                            </h2>
                            {% if sent_from == 1 %}
                            <h2 style="text-align:center;margin-top:0"><small>{{ supplier_name }}({{ target_id }})</small></h2>
                            {% endif %}
                            <p style="margin-bottom:30px"></p>
                            <table class="table table-striped" style="width:70%;margin:0 auto">
                                <tr>
                                    <th>
                                        商品名
                                        <p>
                                            <select class="chosen-select form-control" id="select-product-names" multiple data-placeholder="搜索商品名">
                                                {% for product in products %}
                                                <option value="{{ product.id }}">{{ product.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </p>
                                    </th>
                                    <th>商品ID</th>
                                    <th>编码</th>
                                    <th width="120px">图片</th>
                                    <th>规格ID</th>
                                    <th width="90px">尺寸</th>
                                    <th>待入库数</th>
                                    <th width="80px">正品</th>
                                    <th width="80px">次品</th>
                                    <th width="180px">库位</th>
                                </tr>
                                {% for product in products %}
                                {% for sku in product.skus %}
                                <tr class="sku" data-product-id="{{ product.id }}" data-sku-id="{{ sku.id }}">
                                    {% if forloop.first %}
                                    <td rowspan="{{ product.skus|length }}">{{ product.name }}</td>
                                    <td rowspan="{{ product.skus|length }}">
                                        <a href="/items/product/district/{{product.id}}/" target="_blank" alt="商品库位">
                                            {{ product.id }}
                                        </a>
                                    </td>
                                    <td rowspan="{{ product.skus|length }}">
                                        <a href="/admin/items/product/?outer_id={{ product.outer_id }}" target="_blank">
                                            {{ product.outer_id }}
                                        </a>
                                    </td>
                                    <td rowspan="{{ product.skus|length }}">
                                        <div class="portfolio-box">
                                            <a href="{{ product.product_link }}" target="_blank">
                                                <img src="{{ product.pic_path }}?imageView2/0/w/120" class="img-circle" data-pic-path="{{ product.pic_path }}">
                                            </a>
                                        </div>
                                    </td>
                                    {% endif %}
                                    <td>{{ sku.id }}</td>
                                    <td>{{ sku.properties_name }}</td>
                                    <td class="plan-quantity">
                                        <p class="n">
                                            {{ sku.plan_quantity }}
                                            <i class="glyphicon glyphicon-info-sign warning quantity-warning" data-plan-quantity="{{ sku.plan_quantity }}"></i>
                                        </p>
                                    </td>
                                    <td>
                                        <input type="number" class="arrival-quantity form-control"
                                               style="width:80px" min="0" value="{{ sku.arrival_quantity|default:'' }}">
                                    </td>
                                    <td>
                                        <input type="number" class="inferior-quantity form-control"
                                               style="width:80px" min="0" value="{{ sku.inferior_quantity|default:'' }}">
                                    </td>
                                    <td>
                                        <input class="district form-control" style="width:80px" value="{{ sku.district|default:'' }}">
                                    </td>
                                </tr>
                                {% endfor %}
                                {% endfor %}
                                {% if details %}
                                {% for detail in details %}
                                <tr class="detail" data-detail-id="{{ detail.id }}">
                                    <td style="vertical-align:middle">
                                        <div style="position:relative">
                                            <i class="glyphicon glyphicon-remove remove" onclick="javascript:removeDetail(this);"></i>
                                            <input class="detail-name form-control" placeholder="商品名" value="{{ detail.name|default:'' }}">
                                            <i class="glyphicon glyphicon-info-sign warning name-warning"></i>
                                        </div>
                                    </td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>
                                        <input class="detail-properties-name form-control" style="width:80px" placeholder="尺寸" value="{{ detail.properties_name|default:'' }}">
                                    </td>
                                    <td></td>
                                    <td>
                                        <input type="number" class="arrival-quantity form-control" style="width:80px" min="0" value="{{ detail.arrival_quantity|default:'' }}">
                                    </td>
                                    <td>
                                        <input type="number" class="inferior-quantity form-control" style="width:80px" min="0" value="{{ detail.inferior_quantity|default:'' }}">
                                    </td>
                                    <td>
                                        <input class="district form-control" style="width:80px" value="{{ detail.district|default:'' }}">
                                    </td>
                                </tr>
                                {% endfor %}
                                {% endif %}
                            </table>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <a href="javascript:;" class="btn btn-default btn-block reset">重置</a>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-success btn-block submit">创建</button>
                    </div>
                </div>
            </form>
            {% endif %}
        </div>
        <div class="modal fade" id="memo-modal" tabindex="-1" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body" id="plupload-container">
                        <button type="button" class="close" data-dismiss="modal" arial-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <form>
                            <div class="form-group">
                                <label class="control-label">备注:</label><br>
                                <textarea id="memo" rows="5" cols="40">{{ memo|default:'' }}</textarea>
                            </div>
                            <div class="form-group">
                                <label class="control-label">拍照:</label>
                                <input type="hidden" id="pickfiles">
                                <ul id="images" class="uploader"></ul>
                            </div>
                        </form>
                        <div style="clear:both"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal" style="width:80px">确定</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="memo-panel">
            <ul>
                <li>
                    <span class="label label-success">
                        正: <i id="total-arrival-quantity">0</i>
                    </span>
                </li>
                <li>
                    <span class="label label-warning">
                        次: <i id="total-inferior-quantity">0</i>
                    </span>
                </li>
                <li>
                    <a href="javascript:;" class="btn btn-warning btn-danger" id="add">疑难</a>
                </li>
                <li>
                    <a href="javascript:;" class="btn btn-warning btn-block" id="memo-btn">备注</a>
                </li>
                <li>
                    <a href="javascript:;" class="btn btn-danger btn-block" id="cancel-btn">作废</a>
                </li>
            </ul>
        </div>
        <script src="{{ STATIC_URL }}jquery/jquery-1.8.13.min.js"></script>
        <script src="{{ STATIC_URL }}jquery.noty.packaged.js"></script>
        <script src="{{ STATIC_URL }}underscore/underscore-min.js"></script>
        <script src="{{ STATIC_URL }}bootstrap/js/bootstrap-3.2.0.min.js"></script>
        <script src="{{ STATIC_URL }}list.js"></script>
        <script src="{{ STATIC_URL }}typeahead.bundle.min.js"></script>
        <script src="//cdn.bootcss.com/plupload/2.1.7/plupload.full.min.js"></script>
        <script src="//cdn.bootcss.com/plupload/2.1.7/i18n/zh_CN.js"></script>
        <script src="{{ STATIC_URL }}script/qiniu.js"></script>
        <script src="{{ STATIC_URL }}plugins/xiaolu-uploader/uploader.js"></script>
        <script src="{{ STATIC_URL }}wap/js/sweet-alert.min.js"></script>
        <script src="{{ STATIC_URL }}chosen_v1.5.1/chosen.jquery.js"></script>
        <script src="/static/wap/js/template.js"></script>
        <script src="{{ STATIC_URL }}bootstrap-tagsinput/dist/bootstrap-tagsinput.js"></script>
        {% verbatim %}
        <script id="detail" type="text/html">
            <tr class="detail" data-detail-id="0" data-new-id="{{new_id}}">
                <td style="vertical-align:middle">
                    <div style="position:relative">
                        <i class="glyphicon glyphicon-remove remove" onclick="javascript:removeDetail(this);"></i>
                        <input class="detail-name form-control" placeholder="商品名">
                        <i class="glyphicon glyphicon-info-sign warning name-warning"></i>
                    </div>
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>
                    <input class="detail-properties-name form-control" style="width:80px" placeholder="尺寸">
                </td>
                <td></td>
                <td>
                    <input type="number" class="arrival-quantity form-control" style="width:80px" min="0">
                </td>
                <td>
                    <input type="number" class="inferior-quantity form-control" style="width:80px" min="0">
                </td>
                <td>
                    <input class="district form-control" style="width:80px">
                </td>
            </tr>
        </script>
        {% endverbatim %}

        <script>
         var SENT_FROM_SUPPLIER = 1;
         var SENT_FROM_REFUND = 2;
         var SKU_TR_TPL = _.template('tr[data-sku-id="<%= sku_id %>"]');
         var NEW_DETAIL_TR_TPL = _.template('tr[data-new-id="<%= new_id %>"]');
         var PRODUCT_TR_TPL = _.template('tr[data-product-id="<%= product_id %>"]');
         var IMAGE_PREVIEW_TPL = _.template('<img src="<%= pic_path %>" width=800 height=800>');

         var CREATE_SUPPLIER_INBOUND_URL = '/sale/dinghuo/dinghuo_orderlist/create_supplier_inbound';
         var EDIT_SUPPLIER_INBOUND_URL = '/sale/dinghuo/dinghuo_orderlist/edit_supplier_inbound';

         var CREATE_REFUND_INBOUND_URL = '';
         var EDIT_REFUND_INBOUND_URL = '';

         var suppliers = {{ suppliers|jsonify }};
         var expressNos = {{ express_nos|jsonify }};
         var images = {{ images|jsonify }};

         var districtsEngine = new Bloodhound({
             datumTokenizer: Bloodhound.tokenizers.whitespace,
             queryTokenizer: Bloodhound.tokenizers.whitespace,
             prefetch: '/sale/dinghuo/dinghuo_orderlist/districts'
         });
         districtsEngine.initialize();


         $.noty.defaults = $.extend($.noty.defaults, {
             animation: {
                 open: 'animated bounceInLeft',
                 close: 'animated bounceOutRight',
                 easing: 'swing',
                 speed: 500
             }
         });

         function onSelectChange(e, params){
             var productIds = $('#select-product-names').val();
             if(productIds && productIds.length){
                 var propArray = _.map(productIds, function(el){
                     return PRODUCT_TR_TPL({product_id: el});
                 });

                 $('tr[data-product-id]').each(function(index){
                     var $this = $(this);
                     if($this.is(propArray.join(','))){
                         if($this.is(':visible'))
                             return;
                         $this.slideDown();
                     }
                     else{
                         if($this.is(':visible'))
                             $this.slideUp();
                     }
                 });
             }
             else{
                 $('tr[data-product-id]').slideDown();
             }
         }

         function getFormData(){
             var sku_id, detail_id,new_id;
             var skus, details;
             var arrival_quantity, inferior_quantity;
             var district;
             var formData = {};

             skus = [];
             details = [];
             $('tr', $('#form-2')).each(function(index, el){
                 var $this = $(this);

                 detail_id = parseInt($this.attr('data-detail-id')) || 0;
                 sku_id = parseInt($this.attr('data-sku-id')) || 0;
                 new_id = parseInt($this.attr('data-new-id')) || 0;
                 arrival_quantity = parseInt($this.find('input.arrival-quantity').val());
                 inferior_quantity = parseInt($this.find('input.inferior-quantity').val());
                 district = $this.find('input.district').val() || '1';
                 if(!_.isNaN(arrival_quantity) && _.isNumber(arrival_quantity) || !_.isNaN(inferior_quantity) && _.isNumber(inferior_quantity)){
                     if(sku_id){
                         skus.push({
                             sku_id: sku_id,
                             arrival_quantity: arrival_quantity || 0,
                             inferior_quantity: inferior_quantity || 0,
                             district: district
                         });
                     }
                     else{
                         details.push({
                             id: detail_id,
                             new_id: new_id,
                             name: $this.find('input.detail-name').val(),
                             properties_name: $this.find('input.detail-properties-name').val(),
                             arrival_quantity: arrival_quantity || 0,
                             inferior_quantity: inferior_quantity || 0,
                             district: district
                         });
                     }
                 }
             });

             _.each($('#form-1').serializeArray(), function(el){
                 formData[el.name] = el.value;
             });

             formData.skus = JSON.stringify(skus);
             formData.details = JSON.stringify(details);
             formData.inbound_id = $('#inbound-id').val() - 0 || 0;
             formData.memo = $('#memo').val();
             formData.images = JSON.stringify($('#images').uploader('getData'));
             return formData;
         }

         function getRequestUrl(formData){
             var requestUrl;
             if(formData.sent_from == SENT_FROM_SUPPLIER){
                 if(formData.inbound_id)
                     requestUrl = EDIT_SUPPLIER_INBOUND_URL;
                 else
                     requestUrl = CREATE_SUPPLIER_INBOUND_URL;
             }
             else if(formData.sent_from == SENT_FROM_REFUND){
                 if(formData.inbound_id)
                     requestUrl = EDIT_REFUND_INBOUND_URL;
                 else
                     requestUrl = CREATE_REFUND_INBOUND_URL;
             }
             return requestUrl;
         }

         function onQuantityChange(){
             var $tr = $(this).closest('tr');
             var arrival_quantity = parseInt($tr.find('input.arrival-quantity').val()) || 0;
             var inferior_quantity = parseInt($tr.find('input.inferior-quantity').val()) || 0;
             if(arrival_quantity || inferior_quantity){
                 var $i = $tr.find('i.quantity-warning');
                 var plan_quantity = parseInt($i.attr('data-plan-quantity'));
                 if(arrival_quantity + inferior_quantity > plan_quantity)
                     $i.slideDown();
                 else
                     $i.slideUp();
             }
             calcTotalQuantity();
         }


         function onNameChange(){
             var $this = $(this);
             var name = $this.val().replace(/(^\s*)|(\s*$)/g, '');
             if(name)
                 $this.closest('tr').find('i.name-warning').slideUp();
             else
                 $this.closest('tr').find('i.name-warning').slideDown();
         }

         function removeDetail(el){
             var $tr = $(el).closest('tr');
             var detail_id = parseInt($tr.attr('data-detail-id'));
             var inbound_id = parseInt($('#inbound-id').val());
             if(inbound_id && detail_id){
                 $.ajax({
                     url: '/sale/dinghuo/dinghuo_orderlist/' + inbound_id + '/delete_detail',
                     type: 'post',
                     dataType: 'json',
                     data: {detail_id: detail_id},
                 });
             }
             $tr.remove();
         }

         function calcTotalQuantity(){
             var totalArrivalQuantity = 0;
             var totalInferiorQuantity = 0;

             $('.arrival-quantity').each(function(index, el){
                 var n = parseInt($(this).val());
                 if(n)
                     totalArrivalQuantity += n;
             });

             $('.inferior-quantity').each(function(index, el){
                 var n = parseInt($(this).val());
                 if(n)
                     totalInferiorQuantity += n;
             });
             $('#total-arrival-quantity').html(totalArrivalQuantity);
             $('#total-inferior-quantity').html(totalInferiorQuantity);
         }

         function initUI(formData){
             if(formData.inbound_id){
                 $('#cancel-btn').show();
                 $('#form-2 .reset').hide();
                 $('#form-2 .submit').html('修改');
             }
             calcTotalQuantity();
         }

         $(function(){
             $('#images').uploader({
                 fileButton: 'pickfiles',
                 domain: 'http://image.xiaolu.so/',
                 imageOp: 'imageMogr2/thumbnail/220/crop/220x220/format/jpg',
                 maxLength: 100,
                 width: 100,
                 height: 100
             });
             if(images)
                 $('#images').uploader('setData', images);

             var formData = getFormData();
             initUI(formData);

              var matcher = function(items){
                  return function findMatches(q, cb){
                      var matches, subStrRegex;
                      matches = [];
                      subStrRegex = new RegExp(q, 'i');
                      $.each(items, function(i, item){
                          if(subStrRegex.test(item.text))
                              matches.push(item.text);
                      });
                      cb(matches);
                  };
              };

              $('#supplier').typeahead({
                  hint: true,
                  highlight: true,
                  minLength: 1
              }, {
                  name: 'suppliers',
                  source: matcher(suppliers)
              }).bind('typeahead:select', function(e, suggestion){
                  var i, id;
                  for(i=0; i < suppliers.length; ++i){
                      if(suppliers[i].text == suggestion){
                          id = suppliers[i].id;
                          break;
                      }
                  }
                  if(id){
                      $('#sent-from').val(SENT_FROM_SUPPLIER);
                      $('#target-id').val(id);
                  }
              });

              $('#express-no').typeahead({
                  hint: true,
                  highlight: true,
                  minLength: 1
              }, {
                  name: 'expressNos',
                  source: matcher(expressNos)
              }).bind('typeahead:select', function(e, suggestion){
                  var i, id, sentFrom;
                  for(i=0; i < expressNos.length; ++i){
                      if(expressNos[i].text == suggestion){
                          id = expressNos[i].id;
                          sentFrom = expressNos[i].sent_from;
                          break;
                      }
                  }
                  if(id && sentFrom){
                      $('#sent-from').val(sentFrom);
                      $('#target-id').val(id);
                  }
              });
              $('span.twitter-typeahead:has(.typeahead)').css('display', 'block');

              $('#form-2').submit(function(){
                  var flag = false;
                  $('tr.detail').each(function(){
                      var name = $(this).find('input.detail-name').val().replace(/(^\s*)|(\s*$)/g, '');
                      if(name)
                          $(this).find('i.name-warning').slideUp();
                      else{
                          flag = true;
                          $(this).find('i.name-warning').slideDown();
                      }
                  });
                  if(flag)
                      return false;

                  var formData = getFormData();
                  var requestUrl = getRequestUrl(formData);

                  if(!requestUrl){
                      $('#tips').noty({
                          text: '未能找到请求URL',
                          type: 'error',
                          theme: 'bootstrapTheme',
                          closeWith: ['button', 'click'],
                          maxVisible: 20,
                          modal: false
                      });
                      return;
                  }

                  $.ajax({
                      url: requestUrl,
                      type: 'post',
                      dataType: 'json',
                      data: formData,
                      success: function(result){
                          if(result.error){
                              $('#tips').noty({
                                  text: result.error,
                                  type: 'error',
                                  theme: 'bootstrapTheme',
                                  closeWith: ['button', 'click'],
                                  maxVisible: 20,
                                  modal: false
                              });
                          }
                          else{
                              if(result.inbound_id && (result.inbound_id - 0)){
                                  $('#cancel-btn').show();
                                  $('#inbound-id').val(result.inbound_id);
                                  $('#form-2 .reset').hide();
                                  $('#form-2 .submit').html('修改');
                              }
                              if(result.details){
                                  _.each(result.details, function(el){
                                      if(el.new_id && el.detail_id){
                                          $(NEW_DETAIL_TR_TPL({new_id: el.new_id})).attr('data-detail-id', el.id);
                                      }
                                 });
                             }
                             if(result.msg){
                                 $('#tips').noty({
                                     text: result.msg,
                                     type: 'information',
                                     theme: 'bootstrapTheme',
                                     closeWith: ['button', 'click'],
                                     maxVisible: 20,
                                     modal: false
                                 });
                             }
                         }
                     }
                 });
                 return false;
             });
             $('#form-1 .reset, #form-2 .reset').click(function(){
                 $(this).closest('form').find('input').val('');
             });
             $('#form-1').submit(function(){
                 $('#inbound-id').val('');
                 return true;
             });

             $('#memo-btn').click(function(){
                 $('#memo-modal').modal('toggle');
             });

             $('#cancel-btn').click(function(){
                 swal({
                     title: '警告',
                     text: '作废后无法恢复',
                     type: 'warning',
                     showCancelButton: true,
                     confirmButtonText: '确认',
                     cancelButtonText: '取消'
                 }, function(){
                     var inbound_id = $('#inbound-id').val() - 0;
                     if(!inbound_id)
                         return;
                     $.ajax({
                         url: '/sale/dinghuo/dinghuo_orderlist/' + inbound_id + '/cancel',
                         type: 'post',
                         dataType: 'json',
                         success: function(result){
                             if(result.msg){
                                 $('#tips').noty({
                                     text: result.msg,
                                     type: 'information',
                                     theme: 'bootstrapTheme',
                                     closeWith: ['button', 'click'],
                                     maxVisible: 20,
                                     modal: false
                                 });
                             }
                         }
                     });
                 });
             });
             $('.chosen-select').chosen({
                 no_results_text: '无此记录',
                 search_contains: true
             }).on('change', onSelectChange);

             $('i.quantity-warning').popover({
                 html: true,
                 trigger: 'hover',
                 container: 'body',
                 content: '输入大于待入库数'
             });

             $('i.name-warning').popover({
                 html: true,
                 trigger: 'hover',
                 container: 'body',
                 content: '请填写商品名'
             });

             $('input.arrival-quantity,input.inferior-quantity').each(onQuantityChange).change(onQuantityChange);

             $('#add').click(function(){
                 if($('#target-id').val() - 0){
                     var new_id = 1;
                     if($('tr.detail[data-new-id]').length){
                         new_id = parseInt($('tr.detail[data-new-id]').last().attr('data-new-id')) + 1;
                     }
                     $('table').append(template('detail', {new_id: new_id}));
                     $lastTr = $('table').find('tr.detail').last();
                     $lastTr.find('i.name-warning').popover({
                         html: true,
                         trigger: 'hover',
                         container: 'body',
                         content: '请填写商品名'
                     });
                     $lastTr.find('input.detail-name').change(onNameChange).keyup(onNameChange);
                     $lastTr.find('input.district').tagsinput({
                         typeaheadjs: {name: 'districts', source: districtsEngine.ttAdapter()}
                     });
                 }
             });
             $('.district').tagsinput({
                 hint: false,
                 highlight: false,
                 freeInput: false,
                 typeaheadjs: {
                     hint: false,
                     highlight: false,
                     name: 'districts',
                     source: districtsEngine.ttAdapter()
                 }
             });
             $('img.img-circle').popover({
                 html: true,
                 trigger: 'hover',
                 container: 'body',
                 content: function(){
                     var pic_path = $(this).attr('data-pic-path');
                     return IMAGE_PREVIEW_TPL({pic_path: pic_path});
                 }
             });

         });
        </script>
    </body>
</html>
