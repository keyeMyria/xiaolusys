{% load custom_filter %}
<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <title>小鹿美美 - 入仓后台</title>
        <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <link href="{{ STATIC_URL }}animate.css" rel="stylesheet">
        <link href="{{ STATIC_URL }}plugins/xiaolu-uploader/uploader.css" rel="stylesheet">
        <link href="{{ STATIC_URL }}wap/css/sweet-alert.css" rel="stylesheet">
        <link href="{{ STATIC_URL }}chosen_v1.5.1/chosen.min.css" rel="stylesheet">
        <link href="{{ STATIC_URL }}bootstrap-tagsinput/dist/bootstrap-tagsinput.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.10.0/css/bootstrap-select.min.css">
        <style>
         #form-1 {width:80%;margin-top:10px}

         .typeahead:focus {
             border: 2px solid #0097cf;
         }

         .tt-query {
             -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
             -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
             box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
         }

         .tt-hint {
             color: #999
         }

         .tt-menu {
             margin: 14px 0;
             padding: 8px 0;
             background-color: #fff;
             border: 1px solid #ccc;
             border: 1px solid rgba(0, 0, 0, 0.2);
             -webkit-border-radius: 8px;
             -moz-border-radius: 8px;
             border-radius: 8px;
             -webkit-box-shadow: 0 5px 10px rgba(0,0,0,.2);
             -moz-box-shadow: 0 5px 10px rgba(0,0,0,.2);
             box-shadow: 0 5px 10px rgba(0,0,0,.2);
         }

         .tt-suggestion {
             padding: 3px 20px;
             line-height: 24px;
         }

         .tt-suggestion:hover {
             cursor: pointer;
             color: #fff;
             background-color: #0097cf;
         }

         .tt-suggestion.tt-cursor {
             color: #fff;
             background-color: #0097cf;
         }

         .tt-suggestion p {
             margin: 0;
         }

         #panel-1 {width:80%;margin:20px auto;}
         #form-2 {margin-left:0}
         #form-2 input[type=number] {
             width: 80px;
         }

        </style>
    </head>
    <body>
        <form id="form-1" class="container">
            <div class="row">
                <div class="col-md-6 form-group">
                    <label class="control-label">快递单号</label>
                    <input class="form-control typeahead" id="express-no"
                           name="express_no" placeholder="输入..." value="{{ express_no|default:'' }}">
                </div>
                <div class="col-md-6 form-group">
                    <label class="control-label">订货单号</label>
                    <input class="form-control typeahead" id="orderlist-id"
                           name="orderlist_id" placeholder="输入..." value="{{ orderlist_id|default:'' }}">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <a class="btn btn-default btn-block reset" href="javascript:;">重置</a>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-primary btn-block submit">确定</button>
                </div>
            </div>
            <input type="hidden" id="supplier-id" name="supplier_id" value="{{ supplier_id|default:0 }}">
            <input type="hidden" id="inbound-id" name="inbound_id" value="{{ inbound_id|default:0 }}">
        </form>

        {% if supplier_id %}
        <div class="panel panel-default" id="panel-1">
            <div class="panel-heading">{{ supplier_name }}({{ supplier_id }})</div>
            <div class="panel-body">
                <form class="container" id="form-2">
                    <div class="row">
                        <div class="col-md-5 form-group">
                            <label class="control-label">商品</label>
                            <select class="form-control selectpicker" id="product-id">
                                {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 form-group">
                            <label class="control-label">规格</label>
                            <select class="form-control selectpicker" id="sku-id" data-none-selected-text="#">
                            </select>
                        </div>
                        <div class="col-md-1 form-group">
                            <label class="control-label">正品数</label>
                            <input type="number" class="form-control" id="arrival-quantity" min="0">
                        </div>
                        <div class="col-md-1 form-group">
                            <label class="control-label">次品数</label>
                            <input type="number" class="form-control" id="inferior-quantity" min="0">
                        </div>
                        <div class="col-md-1 form-group">
                            <label class="control-label"></label>
                            <button class="btn btn-success" style="display:block">添加</button>
                        </div>
                    </div>
                </form>
                <form id="form-3">
                </form>
            </div>
        </div>
        {% endif %}

        <script src="{{ STATIC_URL }}jquery/jquery-2.1.1.min.js"></script>
        <script src="{{ STATIC_URL }}jquery.noty.packaged.js"></script>
        <script src="{{ STATIC_URL }}underscore/underscore-min.js"></script>
        <script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="{{ STATIC_URL }}list.js"></script>
        <script src="{{ STATIC_URL }}typeahead.bundle.min.js"></script>
        <script src="//cdn.bootcss.com/plupload/2.1.7/plupload.full.min.js"></script>
        <script src="//cdn.bootcss.com/plupload/2.1.7/i18n/zh_CN.js"></script>
        <script src="{{ STATIC_URL }}script/qiniu.js"></script>
        <script src="{{ STATIC_URL }}script/qiniu_file_name_handler.js"></script>
        <script src="{{ STATIC_URL }}plugins/xiaolu-uploader/uploader.js?v=0.1"></script>
        <script src="{{ STATIC_URL }}wap/js/sweet-alert.min.js"></script>
        <script src="{{ STATIC_URL }}chosen_v1.5.1/chosen.jquery.js"></script>
        <script src="/static/wap/js/template.js"></script>
        <script src="{{ STATIC_URL }}bootstrap-tagsinput/dist/bootstrap-tagsinput.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.10.0/js/bootstrap-select.min.js"></script>
        {% verbatim %}
        <script id="skus" type="text/html">
            {{each skus as sku i}}
            <option value="{{sku.id}}">{{sku.properties_name}}</option>
            {{/each}}
        </script>
        <script id="inbound" type="text/html">
            <table class="table table-striped" style="width:85%;">
                <tr>
                    <th width="200px">商品名</th>
                    <th>商品ID</th>
                    <th>编码</th>
                    <th>所属仓库</th>
                    <th>图片</th>
                    <th>尺寸</th>
                    <th>条码</th>
                    <th>正品</th>
                    <th>次品</th>
                    <th>库位</th>
                </tr>
                {{each products as product i}}
                {{each product.skus as sku j}}
                <tr class="sku" data-product-id="{{product.id}}" data-sku-id="{{sku.id}}">
                    {{if j == 0}}
                    <td rowspan="{{product.skus.length}}">{{product.name}}</td>
                    <td rowspan="{{product.skus.length}}">
                        <a href="/admin/product/district/{{product.id}}/" target="_blank" title="商品库位">
                            {{product.id}}
                        </a>
                    </td>
                    <td rowspan="{{product.skus.length}}">
                        <a href="/admin/items/product/?outer_id={{product.outer_id}}" target="_blank" title="库存商品列表">
                            {{product.outer_id}}
                        </a>
                    </td>
                    <td rowspan="{{product.skus.length}}">
                        <select class="ware-select form-control" data-product-id="{{product.id}}">
                            {{each warehouses as warehouse}}
                            <option value="{{warehouse.value}}"{{if product.ware_by == warehouse.value }} selected{{/if}}>{{warehouse.text}}</option>
                            {{/each}}
                        </select>
                    </td>
                    <td rowspan="{{product.skus.length}}">
                        <div class="portfolio-box">
                            <a href="{{product.product_link}}" target="_blank">
                                <img src="{{product.pic_path}}?imageView2/0/w/120" data-pic-path="{{product.pic_path}}">
                            </a>
                        </div>
                    </td>
                    {{/if}}
                    <td>
                        <a href="/admin/items/productsku/{{sku.id}}/history/" target="_blank">{{sku.properties_name}}</a>
                        <i class="glyphicon glyphicon-copy copy" data-clipboard-text="{{product.outer_id}} {{product.name}} {{sku.properties_name}}"></i>
                    </td>
                    <td>{{sku.barcode}}</td>
                    <td>
                        <input type="number" class="arrival-quantity form-control"
                               style="width:80px" min="0" value="{{sku.arrival_quantity}}">
                    </td>
                    <td>
                        <input type="number" class="inferior-quantity form-control"
                               style="width:80px" min="0" value="{{sku.inferior_quantity}}">
                    </td>
                    <td>
                        <input class="district form-control" style="width:80px" value="{{sku.district}}">
                    </td>
                </tr>
                {{/each}}
                {{/each}}
            </table>
        </script>
        {% endverbatim %}
        <script>
         var WARE_HOUSES = [
             {value: 0, text: '未选仓'},
             {value: 1, text: '上海仓'},
             {value: 2, text: '广州仓'}
         ];


         var orderlistIds = {{ orderlist_ids|jsonify }};
         var expressNos = {{ express_nos|jsonify }};
         var products = {{ products|jsonify }};
         var productsDict = {};
         var skusDict = {};
         var inboundSkusDict = {};

         function init(){
             var i, j;
             for(i = 0; i < products.length; ++i){
                 var product = products[i];
                 productsDict[product.id] = product;
                 for(j = 0; j < product.skus.length; ++j)
                     skusDict[product.skus[j].id] = product.skus[j];
             }
         }


         $.noty.defaults = $.extend($.noty.defaults, {
             animation: {
                 open: 'animated bounceInLeft',
                 close: 'animated bounceOutRight',
                 easing: 'swing',
                 speed: 500
             }
         });

         var matcher = function(items, opt){
             var textField = 'text';
             if(opt)
                 textField = opt.textField;
             return function findMatches(q, cb){
                 var matches, subStrRegex;
                 matches = [];
                 subStrRegex = new RegExp(q, 'i');
                 $.each(items, function(i, item){
                     if(subStrRegex.test(item[textField]))
                         matches.push(item[textField]);
                 });
                 cb(matches);
             };
         };

         function supplierIdHandler(items){
             function wrapper(e, suggestion){
                 var i, id;
                 for(i=0; i < items.length; ++i){
                     if(items[i].text == suggestion){
                         id = items[i].id;
                         break;
                     }
                 }
                 if(i)
                     $('#supplier-id').val(id);
             }
             return wrapper;
         }

         function setupForm2(productId){
             var product = _.find(products, function(el){
                 return el.id == productId;
             });
             $('#sku-id').html(template('skus', {skus: product.skus}));
             $('#sku-id').selectpicker('refresh');
         }

         function buildInboundProducts(inboundSkusDict){
             var i;
             var inboundProducts = {};
             for(skuId in inboundSkusDict){
                 var inboundSku = inboundSkusDict[skuId];
                 var sku = skusDict[skuId];
                 var product = productsDict[inboundSku.productId];

                 var inboundProduct = {
                     id: product.id,
                     name: product.name,
                     pic_path: product.pic_path,
                     outer_id: product.outer_id,
                     ware_by: product.ware_by,
                     product_link: product.product_link,
                     skus: {}
                 }
                 if(!inboundProducts[product.id])
                     inboundProducts[product.id] = inboundProduct;
                 else
                     inboundProduct = inboundProducts[product.id];
                 inboundProduct.skus[skuId] = {
                     id: inboundSku.skuId,
                     arrival_quantity: inboundSku.arrivalQuantity,
                     inferior_quantity: inboundSku.inferiorQuantity,
                     barcode: sku.barcode,
                     properties_name: sku.properties_name
                 }
             }
             var newInboundProducts = [];
             _.each(_.sortBy(_.values(inboundProducts), function(x){return x.id;}), function(y){
                 y.skus = _.sortBy(_.values(y.skus), function(z){return z.id});
                 newInboundProducts.push(y);
             });
             return newInboundProducts;
         }

         $(function(){
             init();

             $('#express-no').typeahead({
                 hint: true,
                 highlight: true,
                 minLength: 1
             }, {name: 'expressNos', source: matcher(expressNos)}).bind('typeahead:select', supplierIdHandler(expressNos));


             $('#orderlist-id').typeahead({
                 hint: true,
                 highlight: true,
                 minLength: 1
             }, {name: 'orderlistIds', source: matcher(orderlistIds)}).bind('typeahead:select', supplierIdHandler(orderlistIds));

             $('span.twitter-typeahead:has(.typeahead)').css('display', 'block');

             $('#product-id').on('changed.bs.select', function(e){
                 var productId = parseInt($(this).val());
                 setupForm2(productId);
             });

             $('#form-2').submit(function(){
                 var productId = parseInt($('#product-id').val());
                 var skuId = parseInt($('#sku-id').val());
                 var arrivalQuantity = parseInt($('#arrival-quantity').val()) || 0;
                 var inferiorQuantity = parseInt($('#inferior-quantity').val()) || 0;

                 if(!(productId && skuId && (arrivalQuantity || inferiorQuantity)))
                     return false;

                 var inboundSkuDict = inboundSkusDict[skuId] || {
                     productId: productId,
                     skuId: skuId,
                     arrivalQuantity: 0,
                     inferiorQuantity: 0
                 }
                 inboundSkuDict.arrivalQuantity += arrivalQuantity;
                 inboundSkuDict.inferiorQuantity += inferiorQuantity;
                 inboundSkusDict[skuId] = inboundSkuDict

                 var inboundProducts = buildInboundProducts(inboundSkusDict);
                 $('#form-3').html(template('inbound', {products: inboundProducts, warehouses: WARE_HOUSES}))
                 return false;
             });

             var productId = parseInt($('#product-id').val());
             if(productId)
                 setupForm2(productId);
         });
        </script>
    </body>
</html>
