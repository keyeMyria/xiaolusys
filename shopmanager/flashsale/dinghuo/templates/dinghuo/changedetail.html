{% extends "dinghuo/dinghuo_base.html" %}
{% block title %}订单详情页{% endblock %}
{% block head_script %}
    <link href='{{ STATIC_URL }}jquery/jquery-ui-1.10.1.css' rel='stylesheet'/>
    <style type="text/css" title="currentStyle">
        @import "{{ STATIC_URL }}jquery-datatable-addon/css/demo_page.css";
        @import "{{ STATIC_URL }}jquery-datatable-addon/css/demo_table.css";
    </style>
    <style type="text/css">

    </style>

    <script type="text/javascript">
        function changestatus(id, button) {

            var url = "/sale/dinghuo/changestatus/";
            var data = {"orderid": id, "func": button.value};
            var orderstatus = $("#order_status");
            var callback = function (res) {
                if (res == "OK") {
                    if (button.id == "zuifeibutton") {
                        orderstatus.text("作废");
                    }
                }


            };
            if (orderstatus.text() == "草稿") {
                $.ajax({url: url, data: data, type: "post", success: callback});
            } else {

            }
        }

        function plusQuantity(orderdetailid) {
            var index = "quantity_" + orderdetailid;
            p = $("#" + index);
            var url = "/sale/dinghuo/plusordertail/";
            var data = {"orderdetailid": orderdetailid};
            var callback = function (res) {
                if (res == "OK") {
                    p.text(parseInt(p.text()) + 1);
                }
            };
            $.ajax({url: url, data: data, type: "post", success: callback});
        }
        function minusQuantity(orderdetailid) {
            var index = "quantity_" + orderdetailid;
            p = $("#" + index);
            if (p.text() != "0") {
                var url = "/sale/dinghuo/minusordertail/";
                var data = {"orderdetailid": orderdetailid};
                var callback = function (res) {
                    if (res == "OK") {
                        p.text(parseInt(p.text()) - 1);
                    }
                };
                $.ajax({url: url, data: data, type: "post", success: callback});
            } else {
                alert("已经为零")
            }
        }
        function minusarrivedQuantity(orderdetailid) {
            var index = "arrival_quantity_" + orderdetailid;
            p = $("#" + index);
            if (p.text() != "0") {
                var url = "/sale/dinghuo/minusarrivedquantity/";
                var data = {"orderdetailid": orderdetailid};
                var callback = function (res) {
                    if (res == "OK") {
                        p.text(parseInt(p.text()) - 1);
                    }
                };
                $.ajax({url: url, data: data, type: "post", success: callback});
            } else {
                alert("已经为零")
            }
        }
        function changearrived(orderdetailid) {
            var index1 = "arrival_quantity_" + orderdetailid;
            var index2 = "arrived_num_" + orderdetailid;
            p1 = $("#" + index1);
            p2 = $("#" + index2);
            console.log(p2.val());
            console.log(p1.html());
            var url = "/sale/dinghuo/changearrivalquantity/";
            var data = {"orderdetailid": orderdetailid, "arrived_num": p2.val()};
            var callback = function (res) {
                var dataObj = eval("(" + res + ")");
                if (dataObj.flag) {
                    p1.html(dataObj.num)
                } else {
                    alert("超过购买总数或者没有填写数量")
                }
            };
            $.ajax({url: url, data: data, type: "post", success: callback});

        }
    </script>
{% endblock %}
{% block container %}
    <div class="container">
        <div class="row" style="margin-top: 20px">
            <div class="col-lg-6">
                <span class="label label-info" style="font-size: 20px">当前状态：</span>
                <label id="order_status" class="label label-success"
                       style="font-size: large">{{ orderlist.status }}</label>
            </div>
            <div class="col-lg-2"></div>
            <div class="col-lg-2">
                <a href="/admin/dinghuo/orderlist" style="text-align: right">
                    <span class="label label-warning" style="font-size: 15px">去订货单页面</span>
                </a>
            </div>
            <div class="col-lg-2">
                <a href="/admin/items/product" style="text-align: right">
                    <span class="label label-info" style="font-size: 15px">去商品页面</span>
                </a>
            </div>
        </div>
        <div class="row" style="margin-top: 20px">

            <div class="col-lg-4">
                <div class="alert alert-success" role="alert">
                    <strong>填写地址:</strong>上海市佘山镇吉业路245号5号楼_{{ orderlist.id }}室
                </div>
            </div>

            <div class="col-lg-4">
                <div class="alert alert-success" role="alert">
                    <strong>大货负责人:</strong>{{ orderlist.receiver }}
                </div>
            </div>
            <div class="col-lg-4">
                <div class="alert alert-success" role="alert">
                    <strong>供 应 商:</strong>{{ orderlist.supplier_name }}
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-4">
                <div class="alert alert-success" role="alert">
                    <strong>备注:</strong>{{ orderlist.note }}
                </div>
            </div>

            <div class="col-lg-4">
                <div class="alert alert-success" role="alert">
                    <strong>快递单号:</strong>{{ orderlist.express_no }}
                </div>
            </div>
            <div class="col-lg-4">
                <div class="alert alert-success" role="alert">
                    <strong>金额:</strong>{{ orderlist.order_amount }}
                </div>
            </div>
        </div>
        {% if flagofstatus %}
            <div class="row" style="text-align: right">
                <div class="col-lg-4"></div>
                <div class="col-lg-4"></div>
                <div class="col-lg-4"><input type="button" class="btn btn-danger" id="zuofeibutton" value="作废"
                                             onclick="changestatus({{ orderlist.id }},this)"></div>
            </div>
        {% else %}
            <hr>
            <div class="row">
                <legend>
                    <h4 class="head-title">仓库管理填写</h4>
                </legend>
            </div>
            <div class="row">
                <form action="/sale/dinghuo/changedetail/{{ orderlist.id }}/" method="post">
                    <div class="col-lg-6">

                        <div class="input-group">
                            <span class="input-group-addon">备注</span>
                                    <textarea style="width: 500px;height:50px;resize: none;" id="id_remarks"
                                              name="remarks"
                                              type="text" required="required" class="form-control"></textarea>
                        </div>
                    </div>
                    <div class="col-lg-2"><select name="status" class="form-control">
                        <option value="验货完成">验货完成</option>
                        <option value="有问题">有问题</option>
                    </select></div>
                    <div class="col-lg-4"><input type="submit" class="btn btn-danger" value="保存"></div>
                </form>
            </div>
        {% endif %}
        <div class="row">

            <legend>
                <h4 class="head-title">详细列表</h4>
            </legend>
        </div>
        <div>
            <table id="orderdetailtable" border="1" class="table table-striped table-bordered table-hover">
                <thead>
                <th>商品编码</th>
                <th>商品名称</th>
                <th>图片</th>
                <th>规格</th>
                <th>数量</th>
                <th>买入价格</th>
                <th>单项价格</th>
                <th>已入库数</th>
                <th>到货数量</th>
                <th>操作</th>
                </thead>
                <tbody>

                {% for order in orderdetails %}
                    <tr id="orderdetail_{{ forloop.counter }}">
                        <td>{{ order.outer_id }}</td>
                        <td>{{ order.product_name }}</td>
                        <td><img src="{{ order.pic_path }}" width="60px" height="60px" class="img-circle"></td>
                        <td>{{ order.product_chicun }}</td>
                        <td align="center">
                            {% if flagofstatus %}
                                <a onclick="plusQuantity({{ order.id }})">
                                    <span class="glyphicon glyphicon-plus"></span></a>&nbsp;
                            {% endif %}
                            <span id="quantity_{{ order.id }}">{{ order.buy_quantity }}</span>
                            {% if flagofstatus %}
                                <a onclick="minusQuantity({{ order.id }})">
                                    <span class="glyphicon glyphicon-minus"></span>
                                </a>
                            {% endif %}
                        </td>
                        <td>{{ order.buy_unitprice }}</td>
                        <td>¥{{ order.total_price }}</td>
                        <td><span id="arrival_quantity_{{ order.id }}">{{ order.arrival_quantity }}</span>
                            {% if not flagofstatus %}
                                <a onclick="minusarrivedQuantity({{ order.id }})">
                                    <span class="glyphicon glyphicon-minus"></span>
                                </a>
                            {% endif %}
                        </td>
                        <td>
                            <input type="number" class="form-control" min="0" max="{{ order.buy_quantity }}"
                                   name="arrived_num" id="arrived_num_{{ order.id }}" required="required">
                        </td>
                        <td><input type="button" class="btn btn-default" onclick="changearrived({{ order.id }})"
                                   value="加入库存"></td>
                    </tr>


                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}
{% block tail_script %}
    <script src="{{ STATIC_URL }}jquery/jquery-2.1.1.min.js"></script>
    <script src="{{ STATIC_URL }}jquery-datatable-addon/jquery.dataTables.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        $('#orderdetailtable').dataTable({
            //"bJQueryUI": true,
            "bAutoWidth": false, //自适应宽度
            "aaSorting": [[1, "asc"]],
            "iDisplayLength": 50,
            "aLengthMenu": [[20, 50, 100, -1], [20, 50, 100, "All"]],
            //"bInfo":true,
            //"sPaginationType": "full_numbers",
            //"sDom": '<"H"Tfr>t<"F"ip>',
            "oLanguage": {
                "sLengthMenu": "每页 _MENU_ 条",
                "sZeroRecords": "抱歉， 没有找到",
                "sInfo": "从 _START_ 到 _END_ /共 _TOTAL_ 条",
                "sInfoEmpty": "没有数据",
                "sSearch": "搜索",
                "sInfoFiltered": "(从 _MAX_ 条数据中检索)",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "前一页",
                    "sNext": "后一页",
                    "sLast": "尾页"
                },
                "sZeroRecords": "没有检索到数据",
                "sProcessing": "<img src='/static/img/loading.gif' />"
            }
        });

    </script>
{% endblock %}