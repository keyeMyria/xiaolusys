{% extends "admin/base_site_v2.html" %}
{% load i18n admin_static admin_list %}
{% load url from future %}
{% load admin_urls %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static "admin/css/changelists.css" %}" />
<link rel="stylesheet" type="text/css" href="{% static "admin/css/forms.css" %}" />
<link href="{{ STATIC_URL }}bootstrap-3.3.4-dist/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
<link href="{{ STATIC_URL }}bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css"/>
<link href="{{ STATIC_URL }}css/base.less" rel="stylesheet/less" type="text/css"/>
<link href="{{ STATIC_URL }}plugins/xiaolu-uploader/uploader.css" rel="stylesheet">
<link href="{{ STATIC_URL }}wap/css/sweet-alert.css" rel="stylesheet">
<style type="text/css">
    .form-row {
        overflow:inherit;
        width:90%;
        float:left;
    }
    .dropdown-menu {
        margin-left:192px !important;
    }
    .dropdown-menu li {
        list-style-type:none;
    }
    .xiaolu-hide {
        display: none !important;
    }
    .margin-left-192 {
        margin-left:192px !important;
    }
    .table_return_goods td{
        width:100px;
    }
    #sku-modal {
        min-width: 650px;
    }
    .popover {
        max-width: 100%;
    }
</style>
{% if cl.formset %}
<link rel="stylesheet" type="text/css" href="{% static "admin/css/forms.css" %}" />
{% endif %}
{% if cl.formset or action_form %}
{% url 'admin:jsi18n' as jsi18nurl %}
<script type="text/javascript" src="{{ jsi18nurl|default:'../../jsi18n/' }}"></script>

{% endif %}
{{ media.css }}
{% if not actions_on_top and not actions_on_bottom %}
<style>
    #changelist table thead th:first-child {width: inherit}
</style>
{% endif %}
{% endblock %}

{% block bodyclass %}change-form{% endblock %}

{% if not is_popup %}
{% block breadcrumbs %}

<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; {{ app_label|capfirst|escape }}
    &rsaquo; {{ opts.verbose_name }}
</div>
{% endblock %}
{% endif %}

{% block coltype %}flex{% endblock %}

{% block content %}
<div id="content-main">
    <b>操作说明：</b><br/>
            采购从商品库存页面利用冗余库存新建退货单。<br/>
            采购审核退货单，确认件数/退回价格/备注无误，即可通过。(目前暂时供应商收件人放在备注中，注意确认)<br/>
            审核完毕后开始发货,退货单进入已经发货状态。<br/>
            供应商收到退货后进行退款，提供退货凭据。<br/>
            采购点击退货完成，录入退货凭证。退货单退货成功。<br/>
            退货成功同时，在财务的入账列表里新增记录，财务自行确认。（目前暂时未实现）<br/>
    <fieldset class="module aligned ">
        <div class="form-row row-through">
            <div>
                <label class="required" for="id_returngoods_id">退货单ID:</label>
                <label class="simple-label" id="id_returngoods_id">{{original.id}}</label>
                <label class="required" for="supplier">供应商:</label>
                <label class="simple-label" id="supplier">{{original.supplier.supplier_name}}</label>
                <label class="required" for="id_return_num">退货数量:</label>
                <label class="simple-label" id="id_return_num" name="return_num">{{original.return_num}}</label>
                <label class="required" for="id_sum_amount">退货总金额:</label>
                <label class="simple-label" id="id_sum_amount" name="sum_amount">{{original.sum_amount}}元</label>
                <label class="required" for="id_noter">退货单录入人:</label>
                <label class="simple-label" id="id_noter" name="noter">{{original.noter}}</label>
                <a href="/sale/dinghuo/returngoods/export/?rg_id={{original.id}}" target="_blank">
                    <span class="label label-success">导出excel</span>
                </a>
                {% if original.status == original.CREATE_RG or original.status == original.VERIFY_RG %}
                <a href="javascript:;" id="add-sku">
                    <span class="label label-primary">添加Sku</span>
                </a>
                {% endif %}
            </div>
        </div>
        <div class="form-row row-through">
            <div>
                <label class="required" for="id_status">状态:</label>
                <label class="simple-label" id="id_status">{{original.get_status_display}}</label>
                {%if original.status == 0%}
                <input type="button" class="btn-mini btn-success" id="id_btn_check" value="审核通过" />&nbsp;&nbsp;
                <input type="button" class="btn-mini btn-success" id="id_btn_destroy" value="作废退货单"/>
                {%elif original.status == 1%}
                <button type="button" class="btn-mini btn-primary" data-toggle="modal" data-target="#myModal">
                  已经发货
                </button>
                <!--%elif original.status == 3%-->
                <!--<input type="button" class="btn-mini btn-success" id="id_btn_refund" value="已经退款"/>-->
                {%elif original.status == 3%}
                <input type="button" class="btn-mini btn-success" id="id_btn_success" value="已经收款"/>&nbsp;&nbsp;
                <input type="button" class="btn-mini btn-success" id="id_btn_error" value="退货失败"/>&nbsp;&nbsp;
                {%endif%}
            </div>
        </div>
        <div class="form-row row-through">
            <div>
                <div><label class="required" for="id_status">退货单详情:</label></div>
                <div class="results">
                    <table>
                        <thead class="table_return_goods">
                        <td>商品ID</td>
                        <td>商品名称</td>
                        <td>商品图片</td>
                        <td>SKU ID</td>
                        <td>SKU编码</td>
                        <td>尺码</td>
                        <td>库位</td>
                        <td>退货数量</td>
                        <td>单件退回价格</td>
                        <td style="min-width:180px">操作</td>
                        </thead>
                        {%for products_item in original.products_item_sku%}
                        {%for detail in products_item.detail_items%}
                        <tr>

                        {%if forloop.first%}
                        <td rowspan={{products_item.detail_length}}><a href="/admin/items/product?id={{products_item.id}}" target="_blank">{{products_item.id}}</a></td>
                        <td rowspan="{{products_item.detail_length}}">{{products_item.title}}</td>
                        <td rowspan="{{products_item.detail_length}}">
                            <div class="portfolio-box">
                                <a href="{{products_item.product_link}}" target="_blank">
                                    <img src="{{products_item.pic_path}}?imageView2/0/w/120" data-pic-path="{{products_item.pic_path}}" width="120px">
                                </a>
                            </div>
                        </td>
                        {%endif%}
                        <td><a href="/admin/items/productsku?id={{detail.skuid}}" target="_blank">{{detail.skuid}}</a></td>
                        <td>{{detail.product_sku.BARCODE}}</td>
                        <td>{{detail.product_sku.properties_name}}</td>
                        <td>{{detail.product_sku.get_districts_code}}</td>
                        <td id="td_num_{{detail.skuid}}"><label id="label_num_{{detail.skuid}}" class="show_sku_{{detail.skuid}}">{{detail.num}}</label>
                            <input id="text_num_{{detail.skuid}}" class="edit_sku_{{detail.skuid}}" type="text" value="{{detail.num}}" style="display: none;width:42px"></td>
                        <td id="td_price_{{detail.skuid}}"><label id="label_price_{{detail.skuid}}" class="show_sku_{{detail.skuid}}">{{detail.price}}</label>
                            <input id="text_price_{{detail.skuid}}" class="edit_sku_{{detail.skuid}}" type="text" value="{{detail.price}}" style="display: none;width:42px"></td>
                        <td>{%if original.status == 0%}
                            <input type="button" class="btn-mini btn_modify" id="btn_modify_{{detail.skuid}}" value="修改"/>&nbsp;&nbsp;
                            <input type="button" class="btn-mini btn_delete" id="btn_delete_{{detail.skuid}}" value="删除"/>&nbsp;&nbsp;
                            <input type="button" class="btn-mini btn_mark_unreturn" id="btn_mark_unreturn_{{detail.skuid}}" value="不可退货"/>
                            {%elif original.status == 1%}
                            <input type="button" class="btn-mini btn_modify" id="btn_modify_{{detail.skuid}}" value="修改"/>&nbsp;&nbsp;
                            <input type="button" class="btn-mini btn_delete" id="btn_delete_{{detail.skuid}}" value="删除"/>&nbsp;&nbsp;
                            <input type="button" class="btn-mini btn_mark_unreturn" id="btn_mark_unreturn_{{detail.skuid}}" value="不可退货"/>
                            {%endif%}
                        </td>
                        </tr>
                        {%endfor%}
                        {%endfor%}
                    </table>
                </div>
            </div>
        </div>
        <div class="form-row field-memo">
            <div>
                <label for="id_memo">备注:</label>
                <textarea class="vLargeTextField" cols="40" id="id_memo" maxlength="512" name="memo" rows="10">{{original.memo}}</textarea>
                <input type="button" class="btn-mini btn-success" id="btn_edit_note" value="修改备注"/>
            </div>
        </div>
        <div class="form-row field-memo">
            <div>
                <label for="id_transactor">负责人:</label>
                <label class="simple-label transactor_text">{{original.transactor.username}}</label>
                <button class="btn-small modify-transactor">修改</button>
                <div class="dropdown xiaolu-hide clearfix">
                  <button id="dLabel" class="dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    {{original.transactor.username}}
                    <span class="caret"></span>
                  </button>
                  <button class="btn-small commit-transactor" style="margin-left:20px;">确认</button>
                  <ul class="dropdown-menu" aria-labelledby="dLabel">
                    {%for u in transactors%}
                      <li><a href="#">{{u.username}}</a></li>
                    {%endfor%}
                  </ul>
                </div>
                    <!--{{original.transactor.username}}-->
                <!--<div class="dropdown">-->
                    <!--<a href="#" class="dropdown-toggle" data-toggle="dropdown">-->
                       <!--Java-->
                       <!--<b class="caret"></b>-->
                    <!--</a>-->
                    <!--<ul class="dropdown-menu">-->
                       <!--<li><a href="#">jmeter</a></li>-->
                       <!--<li><a href="#">EJB</a></li>-->
                       <!--<li><a href="#">Jasper Report</a></li>-->
                       <!--<li class="divider"></li>-->
                       <!--<li><a href="#">分离的链接</a></li>-->
                       <!--<li class="divider"></li>-->
                       <!--<li><a href="#">另一个分离的链接</a></li>-->
                    <!--</ul>-->
                 <!--</div>-->
                <!--<input type="button" class="btn-mini" id="btn_change_transactor" value="修改"/>-->
            </div>
        </div>
        {%if original.has_sent %}
        <div class="form-row field-consigner clearfix">
                <label for="id_consigner">发货人:</label>
                <label class="simple-label" id="id_consigner" name="consigner">{{original.consigner}}</label>
                <label for="label_sid">发货物流单号:</label>
                <label class="simple-label" id="label_sid" name="sid">{{original.sid}}</label>
                <label for="label_logistics_company">发货物流公司:</label>
                <label class="simple-label" id="label_logistics_company" name="sid">{{original.logistics_company.name}}</label>
                <label for="id_consign_time">发货时间:</label>
                <label class="simple-label" id="id_consign_time" style="width:200px">{{original.consign_time|date:"Y-m-d H:i:s"}}</label>
        </div>
        {%endif%}
        {%if original.confirm_pic_url %}
        <div class="form-row field-memo">
            <div>
                <label for="id_refund_picture">付款证明图:</label>
                <a href="{{original.confirm_pic_url}}" target="_blank">
                    <img id="id_refund_picture" src="{{original.confirm_pic_url}}?imageMogr2/thumbnail/220x/format/jpg"
                         width="220px" height="220px" alt="收款证明图" data-pic-path="{{original.confirm_pic_url}}"/>
                </a>
            </div>
        </div>
        {%endif%}
        {%if original.bill %}
        <div class="form-row field-memo">
            <div>
                <label for="id_refund_picture">收款单:</label>
                <a href="/sale/finance/bill/{{original.bill.id}}/" target="_blank">{{original.bill.id}}</a>
            </div>
        </div>
        {%endif%}
        {%if original.has_refund%}
        <div class="form-row field-memo">
            <div>
                <label for="id_refund_fee">收款额:</label>
                <label class="simple-label" id="id_refund_fee">{{original.refund_fee}}</label>
                <label for="id_transcation">交易单号:</label>
                <label class="simple-label" id="id_transcation">{{original.transcation_id}}</label>
                <label for="id_refund_confirmer">收款确认人</label>
                <input type="button" class="btn-mini" id="btn_change_refund" value="修改"/>
                <label class="simple-label" id="id_refund_confirmer">{{original.refund_fee}}</label>
            </div>
        </div>
        {%endif%}
    </fieldset>
</div>
<!-- Modal -->
<div class="modal send" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">物流信息</h4>
      </div>
      <div class="modal-body">
        <label for="id_logistics_no">物流单号</label>
        <input type="text" id="id_logistics_no" value=""/>
        <label for="id_logistics_company">物流公司</label>
        <input type="text" id="id_logistics_company" value="韵达快递"/>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="btn_return_goods_send">保存</button>
      </div>
    </div>
  </div>
</div>
<div class="modal" id="bill-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">创建收款信息</h4>
            </div>
            <div class="modal-body">
                <form id="bill-form" style="position:relative">
                    <input type="hidden" name="rg_id" value="{{original.id}}">
                    <div class="form-group">
                        <label class="control-label">收款方式:</label>
                        <select class="form-control" name="receive_method">
                            <option value="">未选</option>
                            <option value="2">转款</option>
                            <option value="5">余额抵扣</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="control-label">金额:</label>
                        <input type="number" name="amount" class="form-control" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="control-label">交易单号</label>
                        <input name="transaction_no" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="control-label">说明:</label>
                        <textarea class="form-control" rows="3" name="note"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="control-label">附件:</label>
                        <input type="hidden" id="pickfiles">
                        <ul id="files" class="uploader"></ul>
                    </div>
                    <div style="clear:both"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="submit-bill">确定</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="sku-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">添加Sku</h4>
            </div>
            <div class="modal-body">
                <form id="sku-search-form">
                    <div class="row">
                        <div class="col-md-10">
                            <input class="form-control" name="outer_id" placeholder="商品编码..." style="margin-left:10px">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-default">查询</button>
                        </div>
                    </div>
                </form>
                <div id="skus">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="submit-sku">确定</button>
            </div>
        </div>
    </div>
</div>
{% verbatim %}
<script id="skus-tpl" type="text/html">
    <table class="table table-striped">
        <tr>
            <th>商品名</th>
            <th>编码</th>
            <th>图片</th>
            <th>尺寸</th>
            <th>数量</th>
            <th>价格</th>
        </tr>
        <tr>
            {{each product.skus as sku j}}
            <tr class="sku" data-product-id="{{product.id}}" data-sku-id="{{sku.id}}">
                {{if j == 0}}
                <td rowspan="{{product.skus.length}}" style="min-width:150px">{{product.name}}</td>
                <td rowspan="{{product.skus.length}}">{{product.outer_id}}</td>
                <td rowspan="{{product.skus.length}}">
                    <img src="{{product.pic_path}}?imageMogr2/thumbnail/120/crop/120x120/format/jpg" data-pic-path="{{product.pic_path}}" width="120px">
                </td>
                {{/if}}
                <td>
                    <a href="/admin/items/productskustats/?sku_id={{sku.id}}" target="_blank" title="库存列表">{{sku.properties_name}}</a>
                </td>
                <td>
                    <input type="number" class="form-control num" min="0" style="min-width:60px">
                </td>
                <td>
                    <input type="number" class="form-control price" min="0" step="0.1" style="min-width:60px">
                </td>
            </tr>
            {{/each}}
        </tr>
    </table>
</script>
{% endverbatim %}
<script src="//cdn.bootcss.com/plupload/2.1.7/plupload.full.min.js"></script>
<script src="//cdn.bootcss.com/plupload/2.1.7/i18n/zh_CN.js"></script>
<script src="{{ STATIC_URL }}underscore/underscore-min.js"></script>
<script src="{{ STATIC_URL }}underscore/underscore.string.min.js"></script>
<script src="{{ STATIC_URL }}script/qiniu.js"></script>
<script src="{{ STATIC_URL }}script/qiniu_file_name_handler.js"></script>
<script src="{{ STATIC_URL }}plugins/xiaolu-uploader/uploader.js?v=0.1"></script>
<script src="{{ STATIC_URL }}wap/js/sweet-alert.min.js"></script>
<script src="/static/wap/js/template.js"></script>
<script type="text/javascript">
    var id = {{original.id|default_if_none:"0"}};
    function post_data_to_server(act, dom, id) {
        // todo@hy 复制林杰的代码 待修改
        if (dom.hasClass("loading")) {
            return
        }
        dom.addClass("loading");
        var url = "/sale/dinghuo/tuihuo/change_status/";
        var data = {"act_str": act, "id": id};
        $.ajax({"url": url, "data": data, "type": "post", "success": callback});
        function callback(res) {
            dom.removeClass("loading");
            if (res == "True") {
                //刷新当前页面
                window.location.reload();
            }
        }
    }
    function modify_return_goods_sku(sku, id, num, price){
        var url = "/sale/dinghuo/returngoods/modify_return_goods_sku/";
        var data = {"sku_id": sku, "num":num, "price":price, "id": id};
        $.ajax({"url": url, "data": data, "type": "post", "success": callback});
        function callback(res) {
            if (res == "True") {
                window.location.reload();
            }
        }
    }
    function delete_return_goods_sku(sku, id){
        var url = "/sale/dinghuo/returngoods/delete_return_goods_sku/";
        var data = {"sku_id": sku, "id": id};
        $.ajax({"url": url, "data": data, "type": "post", "success": callback});
        function callback(res) {
            if (res == "True") {
                window.location.reload();
            }
        }
    }

    function mark_unreturn_sku(sku_id, id){
        $.ajax({
            url: '/sale/dinghuo/returngoods/mark_unreturn/',
            type: 'post',
            dataType: 'json',
            data: {sku_id: sku_id, id: id},
            complete: function(){
                window.location.reload();
            }
        });
    }
    function set_refund(evt){
        var dom = $("#btn_return_refund");
        var url = "/sale/dinghuo/returngoods/set_refund/";
        var data = {"id": id};
        $.ajax({"url": url, "data": data, "type": "post", "success": callback});
        function callback(res) {
            if (res == "True") {
                window.location.reload();
            }
        }
    }
    function set_return_goods_sku_send(dom, id, logistic_company, logistic_no){
        var url = "/sale/dinghuo/returngoods/set_return_goods_sku_send/";
        var data = {"id": id, "logistic_company":logistic_company,
            "logistic_no": logistic_no
        };
        $.ajax({"url": url, "data": data, "type": "post", "success": callback});
        function callback(res) {
            if (res.code) {
                alert(res.msg);
            }
            else{
                window.location.reload();
            }
        }
    }
    function send_return_goods(evt){
        var dom = $("#btn_return_goods_send");
        var logistic_company = $("#id_logistics_company").val();
        var logistic_no = $("#id_logistics_no").val();
        set_return_goods_sku_send(dom, id, logistic_company, logistic_no)
    }
    var return_check  = function(evt){
        post_data_to_server("ok", $('#id_btn_check'), id);
    }
    var return_destory  = function(evt){
        post_data_to_server("no", $('#id_btn_destroy'), id);
    }
    var return_send  = function(evt){
        post_data_to_server("send", $('#id_btn_send'), id);
    }
    var return_success  = function(evt){
        $('#bill-modal').modal('show');
        //post_data_to_server("send_ok", $('#id_btn_success'), id);
    }
    var return_error = function(evt){
        post_data_to_server("send_fail", $('#id_btn_error'), id);
    }
    var edit_note = function(evt){
        var dom = $('#btn_edit_note');
        if (dom.hasClass("loading")) {
            return
        }
        var memo = $("#id_memo").val();
        dom.addClass("loading");
        var url = "/sale/dinghuo/returngoods/update_memo/";
        var data = {"memo": memo, "id": id};
        $.ajax({
            "url": url,
            "data": data,
            "type": "post",
            "success": callback
            });
            function callback(res) {
                dom.removeClass("loading");
                if (res == "True") {
                    //刷新当前页面
                    window.location.reload();
                }
            }
        }

    var edit_sku = function(evt){
        var dom = evt.target;
        var sku_id = dom.id.substring("btn_modify_".length,dom.id.length);
        if ($("#"+dom.id).val()=="确认"){
            num = $("#text_num_"+sku_id).val();
            price = $("#text_price_"+sku_id).val();
            modify_return_goods_sku(sku_id, id, num, price);
        }
        else{
            $(".edit_sku_"+sku_id).show();
            $(".show_sku_"+sku_id).hide();
            $("#"+dom.id).val("确认");
        }
    }
    var delete_sku = function(evt){
        var dom = evt.target;
        if ($("#"+dom.id).hasClass("loading")) {
            return
        }
        $("#"+dom.id).addClass("loading");
        var sku_id = dom.id.substring("btn_delete_".length,dom.id.length);
        if(confirm("确认这个sku不需要退货吗？")){
            delete_return_goods_sku(sku_id, id);
        }
    }

    var mark_unreturn = function(evt){
        var dom = evt.target;
        if($('#'+dom.id).hasClass('loading')){
            return;
        }
        $('#'+dom.id).addClass('loading');
        var sku_id = dom.id.substring('btn_mark_unreturn_'.length, dom.id.length);
        if(confirm('确认设为不可退货')){
            mark_unreturn_sku(sku_id, id);
        }
    }

    function showDialog(manager){
        this.dialog = new goog.ui.Dialog();
        this.orderManager = manager;
        this.trade_id = null;
        this.clickPos = null;
    }

    var modifyTransactor = function() {
        $('.modify-transactor').addClass('xiaolu-hide');
        $('.dropdown').removeClass('xiaolu-hide');
    }

     var saveTransactor = function(evt){
        var transactor = evt.target.text;
        $('.dropdown').data('transactor', transactor);
        $('.transactor_text').text(transactor);
     }

    var commitTransactor = function(){
        $('.modify-transactor').removeClass('xiaolu-hide');
        $('.dropdown').addClass('xiaolu-hide');
        var dom = $('.dropdown-menu');
        if (dom.hasClass("loading")) {
            return
        }
        var transactor = $('.dropdown').data('transactor');
        dom.addClass("loading");
        var url = "/sale/dinghuo/returngoods/set_transactor/";
        var data = {"transactor": transactor, "id": id};
        $.ajax({
            "url": url,
            "data": data,
            "type": "post",
            "success": callback
            });
            function callback(res) {
                dom.removeClass("loading");
                if (res == "True") {
                    //刷新当前页面
                    window.location.reload();
                }
            }
    }


    function getBillFormData(){
        var data = {};
        _.each($('#bill-form').serializeArray(), function(el){
            data[el.name] = el.value;
        });

        var files = $('#files').uploader('getData');
        data.attachment = files.length > 0 ? files[0] : '';
        return data;
    }

    function getSkuSearchFormData(){
        var data = {};
        _.each($('#sku-search-form').serializeArray(), function(el){
            data[el.name] = $.trim(el.value);
        });
        return data;
    }

    $(document).ready(function () {
        $('#id_btn_check').click(return_check);
        $('#id_btn_destroy').click(return_destory);
        //$('#id_btn_send').click(return_send);
        $('#btn_return_goods_send').click(send_return_goods);
        //$('#id_btn_refund').click(set_refund);
        $('#id_btn_success').click(return_success);
        $('#id_btn_error').click(return_error);
        $('#btn_edit_note').click(edit_note);
        $('.btn_modify').click(edit_sku);
        $('.btn_delete').click(delete_sku);
        $('.btn_mark_unreturn').click(mark_unreturn);
        $('#set_return_goods_sku_send').click(set_return_goods_sku_send);
        $('.modify-transactor').click(modifyTransactor);
        $('.dropdown-menu li').click(saveTransactor);
        $('.commit-transactor').click(commitTransactor);

        $('#files').uploader({
            fileButton: 'pickfiles',
            domain: 'http://image.xiaolu.so/',
            imageOp: 'imageMogr2/thumbnail/220/crop/220x220/format/jpg',
            maxLength: 1,
            width: 100,
            height: 100
        });

        $('#submit-bill').click(function(){
            var data = getBillFormData();
            data.amount = parseFloat(data.amount);
            data.receive_method = parseInt(data.receive_method);
            if(!(data.amount && _.isNumber(data.amount))){
                alert('金额错误');
                return;
            }
            if(!(data.receive_method && _.isNumber(data.receive_method))){
                alert('收款方式错误');
                return;
            }

            $.ajax({
                url: '/sale/dinghuo/returngoods/deal/',
                type: 'post',
                dataType: 'json',
                data: data,
                success: function(result){
                    if(result.code){
                        alert(result.msg);
                        $('#bill-modal').modal('hide');
                    }
                    else
                        window.location.reload();
                }
            });
        });

        $('#add-sku').click(function(){
            $('#sku-modal').modal('show');
        });

        $('#sku-search-form').submit(function(){
            $.ajax({
                url: '/items/query/',
                type: 'get',
                dataType: 'json',
                data: getSkuSearchFormData(),
                success: function(result){
                    if(result.code){
                        alert(result.msg);
                    }
                    else
                        $('#skus').html(template('skus-tpl', result));
                }
            });
            return false;
        });

        $('#submit-sku').click(function(){
            var skus = {};
            $('tr.sku', '#skus').each(function(){
                var $this = $(this);
                var skuId = parseInt($this.attr('data-sku-id'));
                var productId = parseInt($this.attr('data-product-id'));
                var n = $this.find('input.num').val();
                var p = $this.find('input.price').val();
                n = parseInt(n);
                p = parseFloat(p) || 0;
                if(n){
                    skus[skuId] = {
                        num: n,
                        price: p
                    };
                }
            });
            if(!_.isEmpty(skus)){
                $.ajax({
                    url: '/sale/dinghuo/returngoods/add_sku/',
                    type: 'post',
                    dataType: 'json',
                    data: {skus: JSON.stringify(skus), rg_id: {{original.id}}},
                    success: function(result){
                        if(result.code){
                            alert(result.msg);
                        }
                        else{
                            window.location.reload();
                        }
                    }
                });
            }
        });
        $('img[data-pic-path]').popover({
            html: true,
            trigger: 'hover',
            container: 'body',
            content: function(){
                var tpl = _.template('<img src="<%= pic_path %>" width=650 height=650>');
                return tpl({pic_path: $(this).attr('data-pic-path')});
            }
        });
    });

</script>
{% endblock %}
